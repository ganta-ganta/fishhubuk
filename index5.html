<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St. Margaret's Fish Bar - Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-storage-compat.js"></script>
    
    <style>
        /* [Keep ALL your existing CSS styles exactly as they are] */
        /* Your complete CSS from the original code goes here */
        /* For brevity, I'm not duplicating all 1000+ lines of CSS */
        /* But ALL your styling remains the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-red: #d32f2f;
            --dark-red: #b71c1c;
            --light-red: #ff6659;
            --black: #121212;
            --dark-gray: #212121;
            --gray: #424242;
            --light-gray: #757575;
            --white: #ffffff;
            --off-white: #f5f5f5;
            --success: #4caf50;
            --warning: #ff9800;
            --info: #2196f3;
            --kitchen-orange: #ff5722;
            --delivery-blue: #2196f3;
        }
        
        body {
            background-color: var(--black);
            color: var(--off-white);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header Styles */
        header {
            background-color: var(--black);
            color: var(--white);
            padding: 1.2rem 0;
            box-shadow: 0 3px 15px rgba(0,0,0,0.5);
            border-bottom: 3px solid var(--primary-red);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            color: var(--primary-red);
        }
        
        .logo-text h1 {
            font-size: 1.6rem;
            margin-bottom: 5px;
            color: var(--white);
        }
        
        .logo-text p {
            color: var(--light-gray);
            font-size: 0.8rem;
            letter-spacing: 1px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info span {
            color: var(--light-gray);
        }
        
        .logout-btn {
            background-color: var(--dark-gray);
            color: var(--white);
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background-color: var(--primary-red);
        }
        
        /* Navigation Tabs */
        .tabs {
            display: flex;
            background-color: var(--dark-gray);
            border-bottom: 2px solid var(--primary-red);
            overflow-x: auto;
        }
        
        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            color: var(--light-gray);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            border-right: 1px solid var(--gray);
        }
        
        .tab.active {
            background-color: var(--primary-red);
            color: var(--white);
        }
        
        .tab:hover:not(.active) {
            background-color: var(--gray);
            color: var(--white);
        }
        
        /* Sub Tabs */
        .sub-tabs {
            display: flex;
            background-color: var(--dark-gray);
            border-bottom: 1px solid var(--gray);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .sub-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--light-gray);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            border-right: 1px solid var(--gray);
        }
        
        .sub-tab.active {
            background-color: var(--gray);
            color: var(--white);
            border-bottom: 3px solid var(--primary-red);
        }
        
        .sub-tab:hover:not(.active) {
            background-color: var(--gray);
            color: var(--white);
        }
        
        /* Main Content */
        .main-content {
            padding: 30px 0;
            min-height: calc(100vh - 180px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-left: 5px solid var(--primary-red);
        }
        
        .card h3 {
            font-size: 1rem;
            color: var(--light-gray);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 5px;
        }
        
        .card .trend {
            font-size: 0.9rem;
        }
        
        .card .trend.up {
            color: var(--success);
        }
        
        .card .trend.down {
            color: var(--primary-red);
        }
        
        /* Kitchen View Cards */
        .kitchen-orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .kitchen-order-card {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-left: 5px solid var(--kitchen-orange);
            position: relative;
        }
        
        .kitchen-order-card.urgent {
            border-left: 5px solid var(--primary-red);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 87, 34, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0); }
        }
        
        .kitchen-order-card.completed {
            border-left: 5px solid var(--success);
        }
        
        .timer-display {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--kitchen-orange);
        }
        
        .timer-display.warning {
            color: var(--warning);
        }
        
        .timer-display.danger {
            color: var(--primary-red);
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Orders Grid */
        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .order-card {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-left: 5px solid var(--primary-red);
        }
        
        .order-card.pending {
            border-left: 5px solid var(--warning);
        }
        
        .order-card.preparing {
            border-left: 5px solid var(--kitchen-orange);
        }
        
        .order-card.completed {
            border-left: 5px solid var(--success);
        }
        
        .order-card.delivery {
            border-left: 5px solid var(--delivery-blue);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray);
        }
        
        .order-id {
            font-weight: 700;
            color: var(--white);
            font-size: 1.2rem;
        }
        
        .order-time {
            color: var(--light-gray);
            font-size: 0.9rem;
        }
        
        .order-items {
            margin-bottom: 20px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--gray);
        }
        
        .order-total {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--white);
            padding-top: 15px;
            border-top: 2px solid var(--gray);
        }
        
        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-box {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .chart-box h3 {
            color: var(--white);
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid var(--primary-red);
            padding-bottom: 10px;
        }
        
        /* Tables */
        .table-container {
            background-color: var(--dark-gray);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background-color: var(--primary-red);
        }
        
        th {
            padding: 15px;
            text-align: left;
            color: var(--white);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        tbody tr {
            border-bottom: 1px solid var(--gray);
            transition: background-color 0.3s;
        }
        
        tbody tr:hover {
            background-color: var(--gray);
        }
        
        td {
            padding: 15px;
            color: var(--off-white);
        }
        
        /* Forms */
        .form-container {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--white);
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--black);
            border: 1px solid var(--gray);
            border-radius: 5px;
            color: var(--white);
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-red);
        }
        
        .btn {
            padding: 12px 25px;
            background-color: var(--primary-red);
            color: var(--white);
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .btn:hover {
            background-color: var(--dark-red);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--gray);
        }
        
        .btn-secondary:hover {
            background-color: var(--light-gray);
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #3d8b40;
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        .btn-warning:hover {
            background-color: #e68900;
        }
        
        .btn-info {
            background-color: var(--info);
        }
        
        .btn-info:hover {
            background-color: #0b7dda;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        /* Filters */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: var(--dark-gray);
            border-radius: 8px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.9));
            background-size: cover;
            background-position: center;
        }
        
        .login-box {
            background-color: var(--dark-gray);
            border-radius: 10px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            border-top: 5px solid var(--primary-red);
        }
        
        .login-box h2 {
            text-align: center;
            color: var(--white);
            margin-bottom: 30px;
            font-size: 1.8rem;
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-preparing {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-ready {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-delivery {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
        
        /* Auto-refresh Indicator */
        .auto-refresh-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: var(--success);
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        
        /* Notification Sound Icon */
        .sound-toggle {
            cursor: pointer;
            color: var(--light-gray);
            transition: color 0.3s;
        }
        
        .sound-toggle.active {
            color: var(--success);
        }
        
        /* Responsive Design */
        @media (max-width: 1100px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .tabs {
                overflow-x: scroll;
            }
            
            .tab {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .dashboard-cards {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .card .value {
                font-size: 2rem;
            }
            
            .orders-grid, .kitchen-orders-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-box {
                padding: 15px;
            }
            
            .sub-tabs {
                overflow-x: scroll;
            }
        }
        
        @media (max-width: 576px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .action-buttons {
                flex-wrap: wrap;
            }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--black);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-red);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-red);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--dark-gray);
            padding: 30px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray);
        }
        
        .modal-title {
            color: var(--white);
            font-size: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--light-gray);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: var(--white);
        }
        
        /* Cooking Time Settings */
        .cooking-time-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray);
        }
        
        .cooking-time-name {
            flex: 1;
        }
        
        .cooking-time-input {
            width: 100px;
            padding: 8px;
            background-color: var(--black);
            border: 1px solid var(--gray);
            border-radius: 5px;
            color: var(--white);
        }
        
        /* Audio Notification */
        #notification-sound {
            display: none;
        }
        
        /* Connection Status */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .connection-online {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }
        
        .connection-offline {
            background-color: rgba(211, 47, 47, 0.2);
            color: var(--primary-red);
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .connection-online .connection-dot {
            background-color: var(--success);
            animation: pulse 2s infinite;
        }
        
        .connection-offline .connection-dot {
            background-color: var(--primary-red);
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary-red);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--dark-gray);
            color: var(--white);
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left: 4px solid var(--success);
        }
        
        .toast.error {
            border-left: 4px solid var(--primary-red);
        }
        
        .toast.warning {
            border-left: 4px solid var(--warning);
        }
        
        .toast.info {
            border-left: 4px solid var(--info);
        }

    </style>
</head>
<body>
    <!-- Audio for notifications -->
    <audio id="notification-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-kitchen-timer-1006.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span id="toast-message">Message</span>
    </div>
    
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <h2>St. Margaret's Fish Bar</h2>
            <h3 style="text-align: center; color: var(--light-gray); margin-bottom: 30px;">Management System v2.0</h3>
            
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="username" class="form-control" value="stfishhub@gmail.com" placeholder="Enter email">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" class="form-control" value="password" placeholder="Enter password">
            </div>
            <div class="form-group">
                <button id="login-btn" class="btn" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Login with Firebase
                </button>
            </div>
            <div class="form-group" style="text-align: center;">
                <button id="register-btn" class="btn btn-info" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-user-plus"></i> Register New Account
                </button>
                <button id="offline-mode-btn" class="btn btn-secondary" style="width: 100%;">
                    <i class="fas fa-laptop"></i> Use Offline Mode
                </button>
            </div>
            <p style="text-align: center; color: var(--light-gray); margin-top: 20px; font-size: 0.9rem;">
                Default: <strong>stfishhub@gmail.com</strong> / <strong>password</strong>
            </p>
            <div id="login-status" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
        </div>
    </div>
    
    <!-- Main Application -->
    <div id="app" style="display: none;">
        <!-- Header -->
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-fish"></i>
                        </div>
                        <div class="logo-text">
                            <h1>ST. MARGARET'S FISH BAR</h1>
                            <p>MANAGEMENT SYSTEM v2.0</p>
                        </div>
                    </div>
                    
                    <div class="user-info">
                        <span id="current-user">Loading...</span>
                        <span id="current-date"></span>
                        <span id="connection-status" class="connection-status connection-offline">
                            <span class="connection-dot"></span>
                            <span class="connection-text">Offline</span>
                        </span>
                        <i class="fas fa-bell sound-toggle active" id="sound-toggle" title="Toggle notification sound"></i>
                        <a href="#" id="logout-link" class="logout-btn">Logout</a>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="dashboard">Dashboard</button>
            <button class="tab" data-tab="orders">Orders</button>
            <button class="tab" data-tab="kitchen">Kitchen View</button>
            <button class="tab" data-tab="staff">Staff Management</button>
            <button class="tab" data-tab="menu">Menu Management</button>
            <button class="tab" data-tab="reports">Reports</button>
            <button class="tab" data-tab="settings">Settings</button>
        </div>
        
        <!-- Main Content -->
        <div class="container main-content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="d-flex justify-between align-center mb-30">
                    <h2 style="color: var(--white); font-size: 1.8rem;">Dashboard Overview</h2>
                    <div class="d-flex align-center">
                        <span style="color: var(--light-gray); margin-right: 10px;">Auto-refresh: 30s</span>
                        <div class="auto-refresh-indicator"></div>
                    </div>
                </div>
                
                <!-- Dashboard Cards -->
                <div class="dashboard-cards">
                    <div class="card">
                        <h3>Today's Revenue</h3>
                        <div class="value" id="today-revenue">£0.00</div>
                        <div class="trend up" id="today-trend">+0% vs yesterday</div>
                    </div>
                    
                    <div class="card">
                        <h3>Monthly Revenue</h3>
                        <div class="value" id="month-revenue">£0.00</div>
                        <div class="trend up" id="month-trend">+0% vs last month</div>
                    </div>
                    
                    <div class="card">
                        <h3>Active Orders</h3>
                        <div class="value" id="active-orders">0</div>
                        <div class="trend">Pending: <span id="pending-orders">0</span></div>
                    </div>
                    
                    <div class="card">
                        <h3>Kitchen Queue</h3>
                        <div class="value" id="kitchen-queue">0</div>
                        <div class="trend">Preparing: <span id="preparing-orders">0</span></div>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="charts-container">
                    <div class="chart-box">
                        <h3>Revenue This Week</h3>
                        <canvas id="revenueChart"></canvas>
                    </div>
                    
                    <div class="chart-box">
                        <h3>Top Selling Items</h3>
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                
                <!-- Recent Orders Table -->
                <div class="table-container">
                    <div class="d-flex justify-between align-center" style="padding: 20px; border-bottom: 1px solid var(--gray);">
                        <h3 style="color: var(--white);">Recent Orders</h3>
                        <button id="refresh-dashboard" class="btn btn-small">Refresh Now</button>
                    </div>
                    <table id="recent-orders-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Type</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="recent-orders-body">
                            <tr><td colspan="7" style="text-align: center; padding: 30px;">Loading orders...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Orders Tab -->
            <div id="orders" class="tab-content">
                <!-- Sub Tabs for Orders -->
                <div class="sub-tabs">
                    <button class="sub-tab active" data-subtab="all-orders">All Orders</button>
                    <button class="sub-tab" data-subtab="new-order">New Order</button>
                    <button class="sub-tab" data-subtab="delivery">Delivery Orders</button>
                    <button class="sub-tab" data-subtab="takeaway">Takeaway Orders</button>
                </div>
                
                <!-- All Orders Sub Tab -->
                <div id="all-orders" class="sub-tab-content active">
                    <div class="d-flex justify-between align-center mb-30">
                        <h2 style="color: var(--white); font-size: 1.8rem;">Order Management</h2>
                        <div class="d-flex gap-10">
                            <button id="export-orders" class="btn btn-success">Export CSV</button>
                            <button id="refresh-orders" class="btn">Refresh</button>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="filters">
                        <div class="filter-group">
                            <label>Date Range</label>
                            <input type="date" id="filter-date-from" class="form-control">
                        </div>
                        <div class="filter-group">
                            <label>To</label>
                            <input type="date" id="filter-date-to" class="form-control">
                        </div>
                        <div class="filter-group">
                            <label>Order Type</label>
                            <select id="filter-type" class="form-control">
                                <option value="all">All Types</option>
                                <option value="walk-in">Walk-in</option>
                                <option value="just-eat">Just Eat</option>
                                <option value="deliveroo">Deliveroo</option>
                                <option value="uber-eats">Uber Eats</option>
                                <option value="phone">Phone Order</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="filter-status" class="form-control">
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="preparing">Preparing</option>
                                <option value="ready">Ready</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="filter-group d-flex align-center" style="align-self: flex-end;">
                            <button id="apply-filters" class="btn">Apply</button>
                            <button id="clear-filters" class="btn btn-secondary">Clear</button>
                        </div>
                    </div>
                    
                    <!-- Order Cards -->
                    <div class="orders-grid" id="orders-container">
                        <div class="card" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                            <h3>Loading orders...</h3>
                            <p>Please wait while we fetch your orders</p>
                        </div>
                    </div>
                </div>
                
                <!-- New Order Sub Tab -->
                <div id="new-order" class="sub-tab-content">
                    <h2 style="color: var(--white); margin-bottom: 30px; font-size: 1.8rem;">Create New Order</h2>
                    
                    <div class="form-container">
                        <div class="form-group">
                            <label>Order Type</label>
                            <select id="order-type" class="form-control">
                                <option value="walk-in">Walk-in</option>
                                <option value="just-eat">Just Eat</option>
                                <option value="deliveroo">Deliveroo</option>
                                <option value="uber-eats">Uber Eats</option>
                                <option value="phone">Phone Order</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Customer Name</label>
                            <input type="text" id="customer-name" class="form-control" placeholder="Enter customer name">
                        </div>
                        
                        <div class="form-group">
                            <label>Customer Phone</label>
                            <input type="text" id="customer-phone" class="form-control" placeholder="Enter phone number">
                        </div>
                        
                        <div class="form-group">
                            <label>Delivery Address (if delivery)</label>
                            <textarea id="delivery-address" class="form-control" rows="2" placeholder="Enter delivery address"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Select Items</label>
                            <div class="d-flex gap-10 mb-20" style="flex-wrap: wrap;" id="menu-items-container">
                                <!-- Menu items will be loaded dynamically -->
                            </div>
                            <div id="selected-items" style="background-color: var(--black); padding: 15px; border-radius: 5px; min-height: 100px; margin-top: 10px;">
                                <p style="color: var(--light-gray); text-align: center;">No items selected yet</p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Total Amount</label>
                            <input type="text" id="order-total" class="form-control" value="£0.00" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Method</label>
                            <select id="payment-method" class="form-control">
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="just-eat">Just Eat</option>
                                <option value="deliveroo">Deliveroo</option>
                                <option value="uber-eats">Uber Eats</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Notes/Instructions</label>
                            <textarea id="order-notes" class="form-control" rows="3" placeholder="Any special instructions or notes"></textarea>
                        </div>
                        
                        <div class="d-flex gap-10">
                            <button id="submit-order" class="btn">Submit Order</button>
                            <button id="clear-order" class="btn btn-secondary">Clear Form</button>
                        </div>
                    </div>
                </div>
                
                <!-- Delivery Orders Sub Tab -->
                <div id="delivery" class="sub-tab-content">
                    <h2 style="color: var(--white); margin-bottom: 30px; font-size: 1.8rem;">Delivery Orders</h2>
                    <div class="orders-grid" id="delivery-orders-container">
                        <div class="card" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                            <h3>No delivery orders yet</h3>
                            <p>Create a new delivery order to get started</p>
                        </div>
                    </div>
                </div>
                
                <!-- Takeaway Orders Sub Tab -->
                <div id="takeaway" class="sub-tab-content">
                    <h2 style="color: var(--white); margin-bottom: 30px; font-size: 1.8rem;">Takeaway Orders</h2>
                    <div class="orders-grid" id="takeaway-orders-container">
                        <div class="card" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                            <h3>No takeaway orders yet</h3>
                            <p>Create a new takeaway order to get started</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Kitchen View Tab -->
            <div id="kitchen" class="tab-content">
                <div class="d-flex justify-between align-center mb-30">
                    <h2 style="color: var(--white); font-size: 1.8rem;">Kitchen Management</h2>
                    <div class="d-flex gap-10">
                        <button id="refresh-kitchen" class="btn">Refresh Kitchen View</button>
                        <button id="kitchen-settings" class="btn btn-secondary">Kitchen Settings</button>
                    </div>
                </div>
                
                <!-- Kitchen Stats -->
                <div class="dashboard-cards mb-30">
                    <div class="card">
                        <h3>Orders Preparing</h3>
                        <div class="value" id="preparing-count">0</div>
                        <div class="trend">Avg Time: <span id="avg-prep-time">0m</span></div>
                    </div>
                    
                    <div class="card">
                        <h3>Orders Ready</h3>
                        <div class="value" id="ready-count">0</div>
                        <div class="trend">Waiting: <span id="waiting-count">0</span></div>
                    </div>
                    
                    <div class="card">
                        <h3>Urgent Orders</h3>
                        <div class="value" id="urgent-count">0</div>
                        <div class="trend">Overdue: <span id="overdue-count">0</span></div>
                    </div>
                    
                    <div class="card">
                        <h3>Kitchen Efficiency</h3>
                        <div class="value" id="efficiency-rate">0%</div>
                        <div class="trend">Today: <span id="today-completed">0</span> orders</div>
                    </div>
                </div>
                
                <!-- Kitchen Orders Grid -->
                <div class="kitchen-orders-grid" id="kitchen-orders-container">
                    <div class="card" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                        <h3>No orders in the kitchen</h3>
                        <p>All caught up!</p>
                    </div>
                </div>
            </div>
            
            <!-- Staff Management Tab -->
            <div id="staff" class="tab-content">
                <div class="d-flex justify-between align-center mb-30">
                    <h2 style="color: var(--white); font-size: 1.8rem;">Staff Management</h2>
                    <div class="d-flex gap-10">
                        <button id="add-staff-btn" class="btn">Add New Staff</button>
                        <button id="refresh-staff" class="btn btn-secondary">Refresh</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="staff-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Contact</th>
                                <th>Hourly Rate</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staff-table-body">
                            <tr><td colspan="7" style="text-align: center; padding: 30px;">Loading staff...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Menu Management Tab -->
            <div id="menu" class="tab-content">
                <div class="d-flex justify-between align-center mb-30">
                    <h2 style="color: var(--white); font-size: 1.8rem;">Menu Management</h2>
                    <div class="d-flex gap-10">
                        <button id="add-menu-item" class="btn">Add Menu Item</button>
                        <button id="refresh-menu" class="btn btn-secondary">Refresh Menu</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="menu-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price (£)</th>
                                <th>Cost (£)</th>
                                <th>Cook Time (min)</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="menu-table-body">
                            <tr><td colspan="8" style="text-align: center; padding: 30px;">Loading menu items...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2 style="color: var(--white); margin-bottom: 30px; font-size: 1.8rem;">System Settings</h2>
                
                <div class="form-container">
                    <div class="form-group">
                        <label>Business Name</label>
                        <input type="text" id="business-name" class="form-control" value="St. Margaret's Fish Bar">
                    </div>
                    
                    <div class="form-group">
                        <label>Business Address</label>
                        <textarea id="business-address" class="form-control" rows="3">123 Seafood Street, Coastal Town, CT1 2AB</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Business Phone</label>
                        <input type="text" id="business-phone" class="form-control" value="01234 567890">
                    </div>
                    
                    <div class="form-group">
                        <label>Default Order Prefix</label>
                        <input type="text" id="order-prefix" class="form-control" value="SMFB">
                    </div>
                    
                    <div class="form-group">
                        <label>Tax Rate (%)</label>
                        <input type="number" id="tax-rate" class="form-control" value="20" step="0.1" min="0" max="100">
                    </div>
                    
                    <h3 style="color: var(--white); margin: 30px 0 15px;">Data Management</h3>
                    
                    <div class="d-flex gap-10">
                        <button id="backup-data" class="btn btn-secondary">Backup All Data</button>
                        <button id="restore-data" class="btn btn-warning">Restore From Backup</button>
                        <button id="clear-local-data" class="btn" style="background-color: #dc3545;">Clear Local Data</button>
                    </div>
                    
                    <h3 style="color: var(--white); margin: 30px 0 15px;">System Status</h3>
                    
                    <div class="d-flex gap-10 mt-30">
                        <button id="save-settings" class="btn">Save Settings</button>
                        <button id="test-firebase" class="btn btn-info">Test Firebase Connection</button>
                        <button id="reset-system" class="btn btn-warning">Reset System</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Modal -->
    <div id="staff-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Add New Staff</h3>
                <button class="close-modal" id="close-staff-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="staff-name" class="form-control">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="staff-role" class="form-control">
                        <option value="Manager">Manager</option>
                        <option value="Chef">Chef</option>
                        <option value="Server">Server</option>
                        <option value="Delivery">Delivery Driver</option>
                        <option value="Cleaner">Cleaner</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" id="staff-phone" class="form-control">
                </div>
                <div class="form-group">
                    <label>Hourly Rate (£)</label>
                    <input type="number" id="staff-rate" class="form-control" step="0.01" min="0" value="10.50">
                </div>
                <div class="d-flex gap-10 mt-20">
                    <button id="save-staff" class="btn">Save</button>
                    <button id="cancel-staff" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu Item Modal -->
    <div id="menu-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="menu-modal-title">Add Menu Item</h3>
                <button class="close-modal" id="close-menu-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" id="menu-item-name" class="form-control">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="menu-item-category" class="form-control">
                        <option value="Fish">Fish</option>
                        <option value="Sausages">Sausages</option>
                        <option value="Pies">Pies</option>
                        <option value="Burgers">Burgers</option>
                        <option value="Sides">Sides</option>
                        <option value="Specials">Specials</option>
                        <option value="BBQ Chicken">BBQ Chicken</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Price (£)</label>
                    <input type="number" id="menu-item-price" class="form-control" step="0.01" min="0" value="5.00">
                </div>
                <div class="form-group">
                    <label>Cost (£)</label>
                    <input type="number" id="menu-item-cost" class="form-control" step="0.01" min="0" value="2.00">
                </div>
                <div class="form-group">
                    <label>Cook Time (minutes)</label>
                    <input type="number" id="menu-item-cooktime" class="form-control" min="1" value="5">
                </div>
                <div class="d-flex gap-10 mt-20">
                    <button id="save-menu-item" class="btn">Save</button>
                    <button id="cancel-menu-item" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
// ==================== COMPLETE FIRESTORE MANAGEMENT SYSTEM ====================
// ==================== GLOBAL VARIABLES ====================
let currentUser = null;
let orders = [];
let staff = [];
let menuItems = [];
let settings = {};
let selectedOrderItems = [];
let kitchenSettings = {
    alertBeforeTime: 5,
    urgentThreshold: 10,
    kitchenRefreshRate: 30,
    enableSound: true
};
let autoRefreshIntervals = {};
let soundEnabled = true;
let cookingTimers = {};
let orderTimers = {};
let firebaseApp = null;
let firebaseAuth = null;
let firebaseFirestore = null;
let onlineStatus = false;
let realtimeListeners = {};

// ==================== FIREBASE CONFIGURATION ====================
const firebaseConfig = {
    apiKey: "AIzaSyD1v90S_vkiS0CyZYs9Xmwsi5N_G5Nw7JQ",
    authDomain: "fishhub-5df1e.firebaseapp.com",
    projectId: "fishhub-5df1e",
    storageBucket: "fishhub-5df1e.firebasestorage.app",
    messagingSenderId: "360759181280",
    appId: "1:360759181280:web:0b730ac1d442546b393585",
    measurementId: "G-SF2WNZQF6D"
};

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    updateCurrentDate();
    initializeFirebase();
    initEventListeners();
    checkSavedLogin();
});

function initializeFirebase() {
    try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        firebaseAuth = firebaseApp.auth();
        firebaseFirestore = firebaseApp.firestore();
        
        console.log('Firebase initialized successfully with Firestore');
        
        // Setup auth state listener
        firebaseAuth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User signed in:', user.email);
                currentUser = user;
                updateConnectionStatus(true);
                showApp();
                loadInitialData();
                setupRealtimeListeners();
                showToast('Connected to Firebase', 'success');
            } else {
                console.log('User signed out');
                currentUser = null;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });
        
    } catch (error) {
        console.log('Firebase initialization error:', error);
        showToast('Firebase not initialized. Using offline mode.', 'warning');
    }
}

function checkSavedLogin() {
    const savedUser = localStorage.getItem('fishbar_user');
    if (savedUser) {
        try {
            const userData = JSON.parse(savedUser);
            if (userData.loggedIn && userData.timestamp > Date.now() - 24*60*60*1000) {
                if (userData.offline) {
                    useOfflineMode();
                } else {
                    // Auto login will happen via auth state listener
                }
            }
        } catch(e) {
            console.log('No valid saved login');
        }
    }
}

// ==================== AUTHENTICATION ====================
async function firebaseLogin() {
    const email = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
        showToast('Please enter email and password', 'error');
        return;
    }
    
    try {
        showLoading('Logging in...');
        const userCredential = await firebaseAuth.signInWithEmailAndPassword(email, password);
        
        currentUser = userCredential.user;
        
        localStorage.setItem('fishbar_user', JSON.stringify({
            email: email,
            uid: currentUser.uid,
            loggedIn: true,
            timestamp: Date.now()
        }));
        
        showToast('Logged in successfully!', 'success');
        
    } catch (error) {
        console.error('Login error:', error);
        
        if (error.code === 'auth/user-not-found') {
            showToast('User not found. Would you like to register?', 'warning');
        } else if (error.code === 'auth/wrong-password') {
            showToast('Incorrect password', 'error');
        } else if (error.code === 'auth/invalid-email') {
            showToast('Invalid email address', 'error');
        } else {
            showToast(`Login error: ${error.message}`, 'error');
        }
    } finally {
        hideLoading();
    }
}

async function registerNewAccount() {
    const email = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
        showToast('Please enter email and password', 'error');
        return;
    }
    
    if (password.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
    }
    
    try {
        showLoading('Creating account...');
        const userCredential = await firebaseAuth.createUserWithEmailAndPassword(email, password);
        
        currentUser = userCredential.user;
        
        // Initialize user data in Firestore
        await initializeUserData();
        
        localStorage.setItem('fishbar_user', JSON.stringify({
            email: email,
            uid: currentUser.uid,
            loggedIn: true,
            timestamp: Date.now()
        }));
        
        showToast('Account created successfully!', 'success');
        
    } catch (error) {
        console.error('Registration error:', error);
        
        if (error.code === 'auth/email-already-in-use') {
            showToast('Email already registered', 'error');
        } else if (error.code === 'auth/invalid-email') {
            showToast('Invalid email address', 'error');
        } else if (error.code === 'auth/weak-password') {
            showToast('Password is too weak', 'error');
        } else {
            showToast(`Registration error: ${error.message}`, 'error');
        }
    } finally {
        hideLoading();
    }
}

async function initializeUserData() {
    if (!currentUser) return;
    
    try {
        // Initialize settings
        const defaultSettings = getDefaultSettings();
        await firebaseFirestore.collection('settings').doc(currentUser.uid).set(defaultSettings);
        
        // Initialize menu items
        const defaultMenu = getDefaultMenuItems();
        await firebaseFirestore.collection('menuItems').doc(currentUser.uid).set({
            items: defaultMenu,
            lastUpdated: new Date().toISOString()
        });
        
        console.log('User data initialized in Firestore');
    } catch (error) {
        console.error('Error initializing user data:', error);
    }
}

async function firebaseLogout() {
    try {
        // Stop all realtime listeners
        Object.values(realtimeListeners).forEach(unsubscribe => {
            if (typeof unsubscribe === 'function') unsubscribe();
        });
        realtimeListeners = {};
        
        // Clear intervals
        clearAllIntervals();
        stopAllTimers();
        
        // Sign out
        await firebaseAuth.signOut();
        
        currentUser = null;
        orders = [];
        staff = [];
        menuItems = [];
        
        localStorage.removeItem('fishbar_user');
        
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('app').style.display = 'none';
        
        showToast('Logged out successfully', 'info');
        
    } catch (error) {
        console.error('Logout error:', error);
        showToast('Error during logout', 'error');
    }
}

function useOfflineMode() {
    currentUser = { 
        email: document.getElementById('username').value || "stfishhub@gmail.com", 
        uid: 'local-user-offline' 
    };
    
    localStorage.setItem('fishbar_user', JSON.stringify({
        email: currentUser.email,
        loggedIn: true,
        timestamp: Date.now(),
        offline: true
    }));
    
    showApp();
    loadLocalData();
    updateConnectionStatus(false);
    showToast('Using offline mode. Data saved locally.', 'info');
}

// ==================== FIRESTORE DATA OPERATIONS ====================
async function loadInitialData() {
    if (!currentUser || currentUser.uid === 'local-user-offline') {
        loadLocalData();
        return;
    }
    
    try {
        showLoading('Loading data...');
        
        // Load settings
        const settingsDoc = await firebaseFirestore.collection('settings').doc(currentUser.uid).get();
        if (settingsDoc.exists) {
            settings = settingsDoc.data();
        } else {
            settings = getDefaultSettings();
            await firebaseFirestore.collection('settings').doc(currentUser.uid).set(settings);
        }
        
        // Load menu items
        const menuDoc = await firebaseFirestore.collection('menuItems').doc(currentUser.uid).get();
        if (menuDoc.exists && menuDoc.data().items) {
            menuItems = menuDoc.data().items;
        } else {
            menuItems = getDefaultMenuItems();
            await firebaseFirestore.collection('menuItems').doc(currentUser.uid).set({
                items: menuItems,
                lastUpdated: new Date().toISOString()
            });
        }
        
        // Load staff
        const staffSnapshot = await firebaseFirestore.collection('staff')
            .where('userId', '==', currentUser.uid)
            .get();
        staff = staffSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Update UI
        loadSettingsToUI();
        populateMenuButtons();
        displayStaff();
        displayMenuItems();
        initializeCharts();
        startAutoRefresh();
        
        // Save to localStorage as backup
        saveLocalData();
        
        hideLoading();
        
    } catch (error) {
        console.error('Error loading initial data:', error);
        showToast('Error loading data from Firestore', 'error');
        loadLocalData();
    }
}

function setupRealtimeListeners() {
    if (!currentUser || currentUser.uid === 'local-user-offline') return;
    
    // Orders listener
    realtimeListeners.orders = firebaseFirestore.collection('orders')
        .where('userId', '==', currentUser.uid)
        .orderBy('timestamp', 'desc')
        .limit(50)
        .onSnapshot((snapshot) => {
            orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // Update UI based on active tab
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const tabId = activeTab.dataset.tab;
                switch(tabId) {
                    case 'dashboard':
                        updateDashboard();
                        break;
                    case 'orders':
                        displayOrders();
                        break;
                    case 'kitchen':
                        updateKitchenView();
                        break;
                }
            }
            
            // Update all order displays
            updateAllOrderDisplays();
            
            console.log('Orders updated from Firestore');
        }, (error) => {
            console.error('Orders listener error:', error);
            if (error.code !== 'permission-denied') {
                showToast('Error receiving orders updates', 'error');
            }
        });
    
    // Staff listener
    realtimeListeners.staff = firebaseFirestore.collection('staff')
        .where('userId', '==', currentUser.uid)
        .onSnapshot((snapshot) => {
            staff = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (document.querySelector('.tab.active')?.dataset.tab === 'staff') {
                displayStaff();
            }
        }, (error) => {
            console.error('Staff listener error:', error);
        });
}

async function saveOrder(orderData) {
    if (!currentUser) {
        showToast('You must be logged in to save orders', 'error');
        return null;
    }
    
    try {
        // Add metadata
        orderData.userId = currentUser.uid;
        orderData.createdAt = new Date().toISOString();
        orderData.updatedAt = new Date().toISOString();
        
        // Add to Firestore
        const docRef = await firebaseFirestore.collection('orders').add(orderData);
        
        // Update local array
        orderData.id = docRef.id;
        orders.unshift(orderData);
        
        // Save to localStorage as backup
        saveLocalData();
        
        showToast(`Order ${orderData.id} created successfully!`, 'success');
        
        // Play notification sound
        if (soundEnabled) playNotificationSound();
        
        return docRef.id;
        
    } catch (error) {
        console.error('Error saving order:', error);
        showToast('Error saving order to database', 'error');
        
        // Fallback to localStorage
        orderData.id = orderData.id || 'local-' + Date.now();
        orderData.userId = currentUser.uid;
        orders.unshift(orderData);
        saveLocalData();
        
        return orderData.id;
    }
}

async function updateOrderStatus(orderId, newStatus) {
    if (!currentUser) {
        showToast('You must be logged in', 'error');
        return;
    }
    
    try {
        const orderRef = firebaseFirestore.collection('orders').doc(orderId);
        
        // First, get the current order to check ownership
        const orderDoc = await orderRef.get();
        
        if (!orderDoc.exists) {
            showToast('Order not found', 'error');
            return;
        }
        
        // Check if the order belongs to the current user
        const orderData = orderDoc.data();
        if (orderData.userId !== currentUser.uid) {
            showToast('Access denied: This order belongs to another user', 'error');
            return;
        }
        
        // Update the order
        await orderRef.update({
            status: newStatus,
            updatedAt: new Date().toISOString(),
            ...(newStatus === 'completed' ? { completedTime: new Date().toISOString() } : {})
        });
        
        // Update local array
        const orderIndex = orders.findIndex(o => o.id === orderId);
        if (orderIndex !== -1) {
            orders[orderIndex].status = newStatus;
            orders[orderIndex].updatedAt = new Date().toISOString();
            if (newStatus === 'completed') {
                orders[orderIndex].completedTime = new Date().toISOString();
            }
        }
        
        showToast(`Order ${orderId} marked as ${newStatus}`, 'success');
        
        // Play sound for kitchen updates
        if (soundEnabled && (newStatus === 'preparing' || newStatus === 'ready')) {
            playNotificationSound();
        }
        
    } catch (error) {
        console.error('Error updating order:', error);
        
        if (error.code === 'permission-denied') {
            showToast('Permission denied: Check your Firestore security rules', 'error');
        } else if (error.code === 'not-found') {
            showToast('Order not found in database', 'error');
        } else {
            showToast(`Error: ${error.message}`, 'error');
        }
    }
}

async function saveStaff(staffData) {
    if (!currentUser) return null;
    
    try {
        // Add metadata
        staffData.userId = currentUser.uid;
        staffData.createdAt = new Date().toISOString();
        staffData.active = true;
        
        // Add to Firestore
        const docRef = await firebaseFirestore.collection('staff').add(staffData);
        
        // Update local array
        staff.push({ id: docRef.id, ...staffData });
        
        showToast(`Staff member ${staffData.name} added successfully!`, 'success');
        
        return docRef.id;
        
    } catch (error) {
        console.error('Error saving staff:', error);
        showToast('Error saving staff member', 'error');
        return null;
    }
}

async function updateStaff(staffId, staffData) {
    if (!currentUser) return;
    
    try {
        const staffRef = firebaseFirestore.collection('staff').doc(staffId);
        
        // Update in Firestore
        await staffRef.update({
            ...staffData,
            updatedAt: new Date().toISOString()
        });
        
        showToast(`Staff member updated successfully!`, 'success');
        
    } catch (error) {
        console.error('Error updating staff:', error);
        showToast('Error updating staff member', 'error');
    }
}

async function deleteStaff(staffId) {
    if (!currentUser) return;
    
    try {
        await firebaseFirestore.collection('staff').doc(staffId).delete();
        
        // Remove from local array
        const staffIndex = staff.findIndex(s => s.id === staffId);
        if (staffIndex !== -1) {
            staff.splice(staffIndex, 1);
        }
        
        showToast('Staff member deleted successfully!', 'success');
        
    } catch (error) {
        console.error('Error deleting staff:', error);
        showToast('Error deleting staff member', 'error');
    }
}

async function saveMenuItem(menuItemData) {
    if (!currentUser) return;
    
    try {
        // Update local array
        menuItems.push(menuItemData);
        
        // Update in Firestore
        await firebaseFirestore.collection('menuItems').doc(currentUser.uid).update({
            items: menuItems,
            lastUpdated: new Date().toISOString()
        });
        
        showToast(`Menu item ${menuItemData.name} added successfully!`, 'success');
        
    } catch (error) {
        console.error('Error saving menu item:', error);
        showToast('Error saving menu item', 'error');
    }
}

async function updateSettings() {
    if (!currentUser) return;
    
    try {
        const updatedSettings = {
            businessName: document.getElementById('business-name').value,
            businessAddress: document.getElementById('business-address').value,
            businessPhone: document.getElementById('business-phone').value,
            orderPrefix: document.getElementById('order-prefix').value,
            taxRate: parseFloat(document.getElementById('tax-rate').value) || 20,
            updatedAt: new Date().toISOString()
        };
        
        await firebaseFirestore.collection('settings').doc(currentUser.uid).update(updatedSettings);
        
        settings = { ...settings, ...updatedSettings };
        
        showToast('Settings saved successfully!', 'success');
        
    } catch (error) {
        console.error('Error saving settings:', error);
        showToast('Error saving settings', 'error');
    }
}

// ==================== LOCAL STORAGE FUNCTIONS ====================
function saveLocalData() {
    try {
        localStorage.setItem('fishbar_orders', JSON.stringify(orders));
        localStorage.setItem('fishbar_staff', JSON.stringify(staff));
        localStorage.setItem('fishbar_menu', JSON.stringify(menuItems));
        localStorage.setItem('fishbar_settings', JSON.stringify(settings));
        localStorage.setItem('fishbar_lastUpdated', new Date().toISOString());
    } catch (e) {
        console.error('Error saving to localStorage:', e);
    }
}

function loadLocalData() {
    try {
        const savedOrders = localStorage.getItem('fishbar_orders');
        orders = savedOrders ? JSON.parse(savedOrders) : [];
        
        const savedStaff = localStorage.getItem('fishbar_staff');
        staff = savedStaff ? JSON.parse(savedStaff) : [];
        
        const savedMenu = localStorage.getItem('fishbar_menu');
        menuItems = savedMenu ? JSON.parse(savedMenu) : getDefaultMenuItems();
        
        const savedSettings = localStorage.getItem('fishbar_settings');
        settings = savedSettings ? JSON.parse(savedSettings) : getDefaultSettings();
        
        updateDashboard();
        displayOrders();
        displayStaff();
        displayMenuItems();
        loadSettingsToUI();
        populateMenuButtons();
        initializeCharts();
        startAutoRefresh();
        
    } catch (e) {
        console.error('Error loading from localStorage:', e);
        // Initialize with defaults
        orders = [];
        staff = [];
        menuItems = getDefaultMenuItems();
        settings = getDefaultSettings();
    }
}

// ==================== DEFAULT DATA ====================
function getDefaultMenuItems() {
    return [
        { id: 1, name: "Cod", category: "Fish", price: 7.30, cost: 3.50, cookTime: 8, status: "active" },
        { id: 2, name: "Haddock", category: "Fish", price: 8.30, cost: 4.00, cookTime: 8, status: "active" },
        { id: 3, name: "Rock", category: "Fish", price: 7.80, cost: 3.80, cookTime: 7, status: "active" },
        { id: 4, name: "Plaice", category: "Fish", price: 7.80, cost: 3.80, cookTime: 6, status: "active" },
        { id: 5, name: "Skate", category: "Fish", price: 8.80, cost: 4.20, cookTime: 10, status: "active" },
        { id: 6, name: "Sea Bream", category: "Fish", price: 7.30, cost: 3.50, cookTime: 7, status: "active" },
        { id: 7, name: "Sea Bass", category: "Fish", price: 7.50, cost: 3.60, cookTime: 7, status: "active" },
        { id: 8, name: "Fish Cake", category: "Fish", price: 2.30, cost: 1.10, cookTime: 5, status: "active" },
        { id: 9, name: "Chips", category: "Fish", price: 3.00, cost: 0.80, cookTime: 6, status: "active" },
        { id: 10, name: "Jumbo Sausage", category: "Sausages", price: 3.00, cost: 1.20, cookTime: 5, status: "active" },
        { id: 11, name: "Battered Sausage", category: "Sausages", price: 3.30, cost: 1.30, cookTime: 6, status: "active" },
        { id: 12, name: "Saveloy", category: "Sausages", price: 3.00, cost: 1.20, cookTime: 4, status: "active" },
        { id: 13, name: "Pukka Pie", category: "Pies", price: 3.80, cost: 1.50, cookTime: 12, status: "active" },
        { id: 14, name: "Chicken & Mushroom Pie", category: "Pies", price: 3.80, cost: 1.50, cookTime: 12, status: "active" },
        { id: 15, name: "Beef & Onion Pie", category: "Pies", price: 3.80, cost: 1.50, cookTime: 12, status: "active" },
        { id: 16, name: "Steak & Kidney Pie", category: "Pies", price: 3.80, cost: 1.50, cookTime: 12, status: "active" },
        { id: 17, name: "Plain Burger", category: "Burgers", price: 3.80, cost: 1.50, cookTime: 8, status: "active" },
        { id: 18, name: "Cheese Burger", category: "Burgers", price: 4.00, cost: 1.60, cookTime: 8, status: "active" },
        { id: 19, name: "Mushy Peas", category: "Sides", price: 1.80, cost: 0.50, cookTime: 3, status: "active" },
        { id: 20, name: "Curry Sauce", category: "Sides", price: 1.80, cost: 0.40, cookTime: 3, status: "active" },
        { id: 21, name: "Onion Rings", category: "Sides", price: 2.40, cost: 0.80, cookTime: 4, status: "active" },
        { id: 22, name: "Kids Meal", category: "Specials", price: 7.95, cost: 3.50, cookTime: 10, status: "active" },
        { id: 23, name: "BBQ Chicken Half", category: "BBQ Chicken", price: 5.50, cost: 2.50, cookTime: 15, status: "active" },
        { id: 24, name: "BBQ Chicken Whole", category: "BBQ Chicken", price: 8.50, cost: 3.80, cookTime: 20, status: "active" }
    ];
}

function getDefaultSettings() {
    return {
        businessName: "St. Margaret's Fish Bar",
        businessAddress: "123 Seafood Street, Coastal Town, CT1 2AB",
        businessPhone: "01234 567890",
        orderPrefix: "SMFB",
        taxRate: 20,
        createdAt: new Date().toISOString()
    };
}

// ==================== UI FUNCTIONS ====================
function showApp() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('current-user').textContent = currentUser ? currentUser.email : 'Guest';
    updateCurrentDate();
}

function updateCurrentDate() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-GB', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    document.getElementById('current-date').textContent = dateStr;
}

function updateConnectionStatus(isOnline) {
    onlineStatus = isOnline;
    const statusEl = document.getElementById('connection-status');
    const textEl = statusEl.querySelector('.connection-text');
    
    if (isOnline) {
        statusEl.className = 'connection-status connection-online';
        textEl.textContent = 'Online';
    } else {
        statusEl.className = 'connection-status connection-offline';
        textEl.textContent = 'Offline';
    }
}

// ==================== ORDER MANAGEMENT ====================
function createNewOrder() {
    if (selectedOrderItems.length === 0) {
        showToast('Please add items to the order', 'error');
        return;
    }
    
    const customerName = document.getElementById('customer-name').value.trim();
    if (!customerName) {
        showToast('Please enter customer name', 'error');
        return;
    }
    
    const orderId = generateOrderId();
    const orderType = document.getElementById('order-type').value;
    const isDelivery = orderType.includes('delivery') || document.getElementById('delivery-address').value.trim() !== '';
    
    const newOrder = {
        id: orderId,
        customer: customerName,
        phone: document.getElementById('customer-phone').value || '',
        type: orderType,
        delivery: isDelivery,
        deliveryAddress: document.getElementById('delivery-address').value || '',
        items: [...selectedOrderItems],
        total: selectedOrderItems.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 0)), 0),
        status: 'pending',
        timestamp: new Date().toISOString(),
        notes: document.getElementById('order-notes').value || '',
        paymentMethod: document.getElementById('payment-method').value
    };
    
    saveOrder(newOrder);
    
    // Reset form
    selectedOrderItems = [];
    document.getElementById('customer-name').value = '';
    document.getElementById('customer-phone').value = '';
    document.getElementById('delivery-address').value = '';
    document.getElementById('order-notes').value = '';
    updateSelectedItemsDisplay();
    updateOrderTotal();
    
    // Switch to all orders tab
    document.querySelectorAll('.sub-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));
    
    document.querySelector('[data-subtab="all-orders"]').classList.add('active');
    document.getElementById('all-orders').classList.add('active');
}

function generateOrderId() {
    const prefix = settings.orderPrefix || 'SMFB';
    const now = new Date();
    const dateStr = now.getFullYear().toString().substr(-2) + 
                  (now.getMonth() + 1).toString().padStart(2, '0') + 
                  now.getDate().toString().padStart(2, '0');
    const count = orders.filter(o => o.id && o.id.includes(dateStr)).length + 1;
    return `${prefix}-${dateStr}-${count.toString().padStart(3, '0')}`;
}

function addItemToOrder(item) {
    const existingItem = selectedOrderItems.find(i => i.id === item.id);
    
    if (existingItem) {
        existingItem.quantity = (existingItem.quantity || 0) + 1;
    } else {
        selectedOrderItems.push({
            id: item.id,
            name: item.name || 'Unknown',
            price: item.price || 0,
            cookTime: item.cookTime || 5,
            quantity: 1
        });
    }
    
    updateSelectedItemsDisplay();
    updateOrderTotal();
}

function updateSelectedItemsDisplay() {
    const container = document.getElementById('selected-items');
    
    if (selectedOrderItems.length === 0) {
        container.innerHTML = '<p style="color: var(--light-gray); text-align: center;">No items selected yet</p>';
        return;
    }
    
    let html = '<div style="display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid var(--gray); font-weight: bold;">';
    html += '<span>Item</span><span>Qty</span><span>Price</span><span>Action</span></div>';
    
    selectedOrderItems.forEach((item, index) => {
        html += `
            <div style="display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px dashed var(--gray); align-items: center;">
                <span>${item.name || 'Unknown'}</span>
                <span>
                    <button class="btn btn-small" onclick="adjustQuantity(${index}, -1)" style="padding: 2px 8px;">-</button>
                    ${item.quantity || 0}
                    <button class="btn btn-small" onclick="adjustQuantity(${index}, 1)" style="padding: 2px 8px;">+</button>
                </span>
                <span>£${((item.price || 0) * (item.quantity || 0)).toFixed(2)}</span>
                <button class="btn btn-small" onclick="removeItemFromOrder(${index})" style="background-color: var(--primary-red); padding: 2px 8px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function adjustQuantity(index, change) {
    if (!selectedOrderItems[index]) return;
    
    selectedOrderItems[index].quantity = (selectedOrderItems[index].quantity || 0) + change;
    
    if (selectedOrderItems[index].quantity <= 0) {
        selectedOrderItems.splice(index, 1);
    }
    
    updateSelectedItemsDisplay();
    updateOrderTotal();
}

function removeItemFromOrder(index) {
    selectedOrderItems.splice(index, 1);
    updateSelectedItemsDisplay();
    updateOrderTotal();
}

function updateOrderTotal() {
    const total = selectedOrderItems.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 0)), 0);
    document.getElementById('order-total').value = `£${total.toFixed(2)}`;
}

function populateMenuButtons() {
    const container = document.getElementById('menu-items-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!menuItems || menuItems.length === 0) {
        menuItems = getDefaultMenuItems();
    }
    
    // Group items by category
    const categories = {};
    menuItems.forEach(item => {
        if (item.status !== 'active') return;
        
        const category = item.category || 'Other';
        if (!categories[category]) {
            categories[category] = [];
        }
        categories[category].push(item);
    });
    
    // Create buttons for each item
    for (const category in categories) {
        const categoryHeader = document.createElement('div');
        categoryHeader.style.cssText = 'width: 100%; margin-top: 10px; color: var(--primary-red); font-weight: bold;';
        categoryHeader.textContent = category;
        container.appendChild(categoryHeader);
        
        categories[category].forEach(item => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'btn btn-small btn-secondary';
            button.style.margin = '5px';
            button.innerHTML = `${item.name} - £${item.price.toFixed(2)}`;
            button.dataset.id = item.id;
            
            button.addEventListener('click', () => addItemToOrder(item));
            
            container.appendChild(button);
        });
    }
}

// ==================== DASHBOARD FUNCTIONS ====================
function updateDashboard() {
    const today = new Date().toISOString().split('T')[0];
    const todayOrders = orders.filter(order => order.timestamp && order.timestamp.split('T')[0] === today);
    const todayRevenue = todayOrders.reduce((sum, order) => sum + (order.total || 0), 0);
    
    document.getElementById('today-revenue').textContent = `£${todayRevenue.toFixed(2)}`;
    
    const activeOrders = orders.filter(order => order.status !== 'completed' && order.status !== 'cancelled');
    document.getElementById('active-orders').textContent = activeOrders.length;
    
    const pendingOrders = orders.filter(order => order.status === 'pending');
    document.getElementById('pending-orders').textContent = pendingOrders.length;
    
    const kitchenQueue = orders.filter(order => order.status === 'preparing');
    document.getElementById('kitchen-queue').textContent = kitchenQueue.length;
    document.getElementById('preparing-orders').textContent = kitchenQueue.length;
    
    updateRecentOrdersTable();
}

function updateRecentOrdersTable() {
    const tableBody = document.getElementById('recent-orders-body');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    const recentOrders = [...orders]
        .filter(order => order.timestamp)
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 10);
    
    if (recentOrders.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">No orders yet</td></tr>';
        return;
    }
    
    recentOrders.forEach(order => {
        const orderDate = new Date(order.timestamp);
        const timeString = orderDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const itemCount = order.items ? order.items.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${order.id || 'N/A'}</td>
            <td>${order.customer || 'Unknown'}</td>
            <td>${formatOrderType(order.type)}</td>
            <td>${itemCount} items</td>
            <td>£${(order.total || 0).toFixed(2)}</td>
            <td><span class="status-badge status-${order.status || 'pending'}">${order.status || 'pending'}</span></td>
            <td>${timeString}</td>
        `;
        tableBody.appendChild(row);
    });
}

function formatOrderType(type) {
    const types = {
        'walk-in': 'Walk-in',
        'just-eat': 'Just Eat',
        'deliveroo': 'Deliveroo',
        'uber-eats': 'Uber Eats',
        'phone': 'Phone Order'
    };
    return types[type] || type || 'Unknown';
}

// ==================== ORDER DISPLAY FUNCTIONS ====================
function displayOrders() {
    const container = document.getElementById('orders-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    let filteredOrders = [...orders];
    
    const dateFrom = document.getElementById('filter-date-from')?.value;
    const dateTo = document.getElementById('filter-date-to')?.value;
    const typeFilter = document.getElementById('filter-type')?.value || 'all';
    const statusFilter = document.getElementById('filter-status')?.value || 'all';
    
    if (dateFrom) {
        filteredOrders = filteredOrders.filter(order => order.timestamp && order.timestamp.split('T')[0] >= dateFrom);
    }
    
    if (dateTo) {
        filteredOrders = filteredOrders.filter(order => order.timestamp && order.timestamp.split('T')[0] <= dateTo);
    }
    
    if (typeFilter !== 'all') {
        filteredOrders = filteredOrders.filter(order => order.type === typeFilter);
    }
    
    if (statusFilter !== 'all') {
        filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
    }
    
    filteredOrders.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
    
    if (filteredOrders.length === 0) {
        container.innerHTML = '<div class="card" style="text-align: center; padding: 40px; grid-column: 1 / -1;"><h3>No orders found</h3><p>Try adjusting your filters</p></div>';
        return;
    }
    
    filteredOrders.forEach(order => {
        const orderCard = createOrderCard(order);
        container.appendChild(orderCard);
    });
}

function createOrderCard(order) {
    const card = document.createElement('div');
    card.className = `order-card ${order.status || 'pending'}`;
    
    const orderDate = order.timestamp ? new Date(order.timestamp) : new Date();
    const dateString = orderDate.toLocaleDateString('en-GB');
    const timeString = orderDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    let itemsHTML = '';
    if (order.items && order.items.length > 0) {
        order.items.forEach(item => {
            itemsHTML += `
                <div class="order-item">
                    <span>${item.quantity || 0}x ${item.name || 'Unknown'}</span>
                    <span>£${((item.price || 0) * (item.quantity || 0)).toFixed(2)}</span>
                </div>
            `;
        });
    }
    
    card.innerHTML = `
        <div class="order-header">
            <div class="order-id">${order.id || 'N/A'}</div>
            <div class="order-time">${dateString} ${timeString}</div>
        </div>
        <div class="order-items">
            ${itemsHTML || '<p style="color: var(--light-gray); text-align: center;">No items</p>'}
        </div>
        <div class="order-total">
            <span>Total</span>
            <span>£${(order.total || 0).toFixed(2)}</span>
        </div>
        <div class="d-flex justify-between mt-20">
            <div>
                <span class="status-badge status-${order.status || 'pending'}">${order.status || 'pending'}</span>
            </div>
            <div class="action-buttons">
                ${order.status === 'pending' ? '<button class="btn btn-small btn-success approve-btn" data-id="${order.id}">Accept</button>' : ''}
                ${order.status === 'preparing' ? '<button class="btn btn-small btn-warning ready-btn" data-id="${order.id}">Mark Ready</button>' : ''}
                ${order.status === 'ready' ? '<button class="btn btn-small btn-success complete-btn" data-id="${order.id}">Complete</button>' : ''}
                ${order.status !== 'completed' && order.status !== 'cancelled' ? '<button class="btn btn-small btn-secondary cancel-btn" data-id="${order.id}">Cancel</button>' : ''}
            </div>
        </div>
        <div class="mt-10" style="font-size: 0.9rem; color: var(--light-gray);">
            <i class="fas fa-user"></i> ${order.customer || 'Unknown'} | 
            <i class="fas fa-phone"></i> ${order.phone || 'N/A'} |
            <i class="fas fa-${order.delivery ? 'truck' : 'shopping-bag'}"></i> ${order.delivery ? 'Delivery' : 'Takeaway'}
        </div>
        ${order.notes ? `<div class="mt-10" style="font-size: 0.9rem; color: var(--warning);"><i class="fas fa-sticky-note"></i> ${order.notes}</div>` : ''}
    `;
    
    return card;
}

function updateAllOrderDisplays() {
    displayOrders();
    updateDashboard();
    updateKitchenView();
}

// ==================== KITCHEN VIEW FUNCTIONS ====================
function updateKitchenView() {
    const kitchenOrders = orders.filter(order => order.status === 'preparing' || order.status === 'ready');
    const container = document.getElementById('kitchen-orders-container');
    if (!container) return;
    
    // Update stats
    document.getElementById('preparing-count').textContent = orders.filter(o => o.status === 'preparing').length;
    document.getElementById('ready-count').textContent = orders.filter(o => o.status === 'ready').length;
    document.getElementById('urgent-count').textContent = orders.filter(o => isOrderUrgent(o)).length;
    
    const today = new Date().toISOString().split('T')[0];
    const todayCompleted = orders.filter(o => o.status === 'completed' && o.completedTime && o.completedTime.split('T')[0] === today).length;
    document.getElementById('today-completed').textContent = todayCompleted;
    
    container.innerHTML = '';
    
    if (kitchenOrders.length === 0) {
        container.innerHTML = '<div class="card" style="text-align: center; padding: 40px; grid-column: 1 / -1;"><h3>No orders in the kitchen</h3><p>All caught up!</p></div>';
        return;
    }
    
    kitchenOrders.sort((a, b) => {
        const aUrgent = isOrderUrgent(a);
        const bUrgent = isOrderUrgent(b);
        if (aUrgent && !bUrgent) return -1;
        if (!aUrgent && bUrgent) return 1;
        return new Date(a.timestamp || 0) - new Date(b.timestamp || 0);
    });
    
    kitchenOrders.forEach(order => {
        const card = createKitchenOrderCard(order);
        container.appendChild(card);
    });
}

function createKitchenOrderCard(order) {
    const card = document.createElement('div');
    const isUrgent = isOrderUrgent(order);
    const isReady = order.status === 'ready';
    
    card.className = `kitchen-order-card ${isUrgent ? 'urgent' : ''} ${isReady ? 'completed' : ''}`;
    
    const orderDate = order.timestamp ? new Date(order.timestamp) : new Date();
    const timeString = orderDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const elapsedMinutes = getElapsedMinutes(order.timestamp);
    
    let timerDisplay = '';
    if (!isReady) {
        const timeLeft = Math.max(0, getEstimatedCookTime(order) - elapsedMinutes);
        timerDisplay = `<div class="timer-display ${getTimerClass(timeLeft)}">${timeLeft}m</div>`;
    }
    
    let itemsHTML = '';
    if (order.items && order.items.length > 0) {
        order.items.forEach(item => {
            itemsHTML += `
                <div class="order-item">
                    <span>${item.quantity || 0}x ${item.name || 'Unknown'}</span>
                    <span>${item.cookTime || 5}m</span>
                </div>
            `;
        });
    }
    
    card.innerHTML = `
        <div class="order-header">
            <div class="order-id">${order.id || 'N/A'}</div>
            <div class="order-time">${timeString} (${elapsedMinutes}m ago)</div>
        </div>
        ${timerDisplay}
        <div class="order-items">
            ${itemsHTML || '<p style="color: var(--light-gray); text-align: center;">No items</p>'}
        </div>
        <div class="mt-20">
            <div style="color: var(--light-gray); font-size: 0.9rem;">
                <i class="fas fa-${order.delivery ? 'truck' : 'shopping-bag'}"></i> ${order.delivery ? 'Delivery' : 'Takeaway'} |
                <i class="fas fa-user"></i> ${order.customer || 'Unknown'}
            </div>
            ${order.notes ? `<div class="mt-10" style="color: var(--warning); font-size: 0.9rem;"><i class="fas fa-sticky-note"></i> ${order.notes}</div>` : ''}
        </div>
        <div class="action-buttons mt-20">
            ${!isReady ? `
                <button class="btn btn-small btn-success ready-btn" data-id="${order.id}">Mark Ready</button>
                <button class="btn btn-small btn-warning" onclick="addTimeToOrder('${order.id}', 5)">+5 min</button>
            ` : ''}
            <button class="btn btn-small btn-success complete-btn" data-id="${order.id}">Complete Order</button>
        </div>
    `;
    
    return card;
}

function isOrderUrgent(order) {
    if (order.status === 'ready' || order.status === 'completed') return false;
    
    const elapsedMinutes = getElapsedMinutes(order.timestamp);
    const estimatedTime = getEstimatedCookTime(order);
    const threshold = kitchenSettings.urgentThreshold || 10;
    
    return elapsedMinutes > estimatedTime + threshold;
}

function getElapsedMinutes(timestamp) {
    if (!timestamp) return 0;
    const orderTime = new Date(timestamp);
    const now = new Date();
    return Math.floor((now - orderTime) / (1000 * 60));
}

function getEstimatedCookTime(order) {
    if (!order.items || order.items.length === 0) return 5;
    
    const cookTimes = order.items.map(item => item.cookTime || 5);
    return Math.max(...cookTimes);
}

function getTimerClass(minutesLeft) {
    if (minutesLeft <= (kitchenSettings.alertBeforeTime || 5)) {
        return minutesLeft <= 0 ? 'danger' : 'warning';
    }
    return '';
}

// ==================== STAFF MANAGEMENT FUNCTIONS ====================
function displayStaff() {
    const tbody = document.getElementById('staff-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!staff || staff.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">No staff members yet</td></tr>';
        return;
    }
    
    staff.forEach((member, index) => {
        if (!member) return;
        
        const row = document.createElement('tr');
        
        const memberId = member.id || `STAFF-${index + 1}`;
        const memberName = member.name || 'Unknown';
        const memberRole = member.role || 'Staff';
        const memberPhone = member.phone || 'N/A';
        const memberHourlyRate = parseFloat(member.hourlyRate) || 10.50;
        const memberActive = member.active !== false;
        
        row.innerHTML = `
            <td>${memberId}</td>
            <td>${memberName}</td>
            <td>${memberRole}</td>
            <td>${memberPhone}</td>
            <td>£${memberHourlyRate.toFixed(2)}</td>
            <td>
                <span class="status-badge ${memberActive ? 'status-completed' : 'status-pending'}">
                    ${memberActive ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <button class="btn btn-small btn-info" onclick="editStaff('${member.id || index}')">Edit</button>
                <button class="btn btn-small ${memberActive ? 'btn-warning' : 'btn-success'}" onclick="toggleStaffStatus('${member.id || index}')">
                    ${memberActive ? 'Deactivate' : 'Activate'}
                </button>
                <button class="btn btn-small" style="background-color: #dc3545;" onclick="deleteStaff('${member.id || index}')">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function openStaffModal() {
    document.getElementById('modal-title').textContent = 'Add New Staff';
    document.getElementById('staff-name').value = '';
    document.getElementById('staff-role').value = 'Server';
    document.getElementById('staff-phone').value = '';
    document.getElementById('staff-rate').value = '10.50';
    
    document.getElementById('staff-modal').style.display = 'flex';
}

async function saveStaffMember() {
    const name = document.getElementById('staff-name').value.trim();
    if (!name) {
        showToast('Please enter staff name', 'error');
        return;
    }
    
    const newStaff = {
        name: name,
        role: document.getElementById('staff-role').value || 'Server',
        phone: document.getElementById('staff-phone').value || '',
        hourlyRate: parseFloat(document.getElementById('staff-rate').value) || 10.50,
        active: true
    };
    
    const staffId = await saveStaff(newStaff);
    if (staffId) {
        document.getElementById('staff-modal').style.display = 'none';
        displayStaff();
    }
}

// ==================== MENU MANAGEMENT FUNCTIONS ====================
function displayMenuItems() {
    const tbody = document.getElementById('menu-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!menuItems || menuItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px;">No menu items yet</td></tr>';
        return;
    }
    
    menuItems.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.id || index + 1}</td>
            <td>${item.name || 'Unknown'}</td>
            <td>${item.category || 'Other'}</td>
            <td>£${(item.price || 0).toFixed(2)}</td>
            <td>£${(item.cost || 0).toFixed(2)}</td>
            <td>${item.cookTime || 5} min</td>
            <td>
                <span class="status-badge ${item.status === 'active' ? 'status-completed' : 'status-pending'}">
                    ${item.status || 'active'}
                </span>
            </td>
            <td>
                <button class="btn btn-small btn-info" onclick="editMenuItem(${index})">Edit</button>
                <button class="btn btn-small ${item.status === 'active' ? 'btn-warning' : 'btn-success'}" 
                        onclick="toggleMenuItemStatus(${index})">
                    ${item.status === 'active' ? 'Disable' : 'Enable'}
                </button>
                <button class="btn btn-small" style="background-color: #dc3545;" 
                        onclick="deleteMenuItem(${index})">Delete</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function openMenuModal() {
    const modal = document.getElementById('menu-modal');
    if (!modal) {
        showToast('Menu modal not found', 'error');
        return;
    }
    
    document.getElementById('menu-modal-title').textContent = 'Add Menu Item';
    document.getElementById('menu-item-name').value = '';
    document.getElementById('menu-item-category').value = 'Fish';
    document.getElementById('menu-item-price').value = '5.00';
    document.getElementById('menu-item-cost').value = '2.00';
    document.getElementById('menu-item-cooktime').value = '5';
    
    modal.style.display = 'flex';
}

async function saveMenuItemFromModal() {
    const name = document.getElementById('menu-item-name').value.trim();
    if (!name) {
        showToast('Please enter item name', 'error');
        return;
    }
    
    const newMenuItem = {
        id: menuItems.length > 0 ? Math.max(...menuItems.map(m => m.id)) + 1 : 1,
        name: name,
        category: document.getElementById('menu-item-category').value || 'Other',
        price: parseFloat(document.getElementById('menu-item-price').value) || 0,
        cost: parseFloat(document.getElementById('menu-item-cost').value) || 0,
        cookTime: parseInt(document.getElementById('menu-item-cooktime').value) || 5,
        status: 'active'
    };
    
    try {
        // Save to Firestore
        if (currentUser && currentUser.uid !== 'local-user-offline') {
            await firebaseFirestore.collection('menuItems').doc(currentUser.uid).update({
                items: [...menuItems, newMenuItem],
                lastUpdated: new Date().toISOString()
            });
        }
        
        // Update local array
        menuItems.push(newMenuItem);
        
        // Save to localStorage
        saveLocalData();
        
        // Update UI
        populateMenuButtons();
        displayMenuItems();
        
        document.getElementById('menu-modal').style.display = 'none';
        showToast(`Menu item "${name}" added successfully!`, 'success');
        
    } catch (error) {
        console.error('Error saving menu item:', error);
        showToast('Error saving menu item', 'error');
    }
}

function editMenuItem(index) {
    if (!menuItems[index]) return;
    
    const item = menuItems[index];
    const modal = document.getElementById('menu-modal');
    if (!modal) return;
    
    document.getElementById('menu-modal-title').textContent = 'Edit Menu Item';
    document.getElementById('menu-item-name').value = item.name || '';
    document.getElementById('menu-item-category').value = item.category || 'Fish';
    document.getElementById('menu-item-price').value = (item.price || 0).toFixed(2);
    document.getElementById('menu-item-cost').value = (item.cost || 0).toFixed(2);
    document.getElementById('menu-item-cooktime').value = item.cookTime || 5;
    
    modal.dataset.editIndex = index;
    modal.style.display = 'flex';
}

async function updateMenuItem() {
    const modal = document.getElementById('menu-modal');
    if (!modal) return;
    
    const index = modal.dataset.editIndex;
    if (index === undefined || !menuItems[index]) return;
    
    const name = document.getElementById('menu-item-name').value.trim();
    if (!name) {
        showToast('Please enter item name', 'error');
        return;
    }
    
    menuItems[index].name = name;
    menuItems[index].category = document.getElementById('menu-item-category').value || 'Other';
    menuItems[index].price = parseFloat(document.getElementById('menu-item-price').value) || 0;
    menuItems[index].cost = parseFloat(document.getElementById('menu-item-cost').value) || 0;
    menuItems[index].cookTime = parseInt(document.getElementById('menu-item-cooktime').value) || 5;
    
    try {
        // Update in Firestore
        if (currentUser && currentUser.uid !== 'local-user-offline') {
            await firebaseFirestore.collection('menuItems').doc(currentUser.uid).update({
                items: menuItems,
                lastUpdated: new Date().toISOString()
            });
        }
        
        // Save to localStorage
        saveLocalData();
        
        // Update UI
        populateMenuButtons();
        displayMenuItems();
        
        modal.style.display = 'none';
        delete modal.dataset.editIndex;
        showToast('Menu item updated successfully!', 'success');
        
    } catch (error) {
        console.error('Error updating menu item:', error);
        showToast('Error updating menu item', 'error');
    }
}

function toggleMenuItemStatus(index) {
    if (!menuItems[index]) return;
    
    menuItems[index].status = menuItems[index].status === 'active' ? 'inactive' : 'active';
    
    try {
        // Update in Firestore
        if (currentUser && currentUser.uid !== 'local-user-offline') {
            firebaseFirestore.collection('menuItems').doc(currentUser.uid).update({
                items: menuItems,
                lastUpdated: new Date().toISOString()
            });
        }
        
        // Save to localStorage
        saveLocalData();
        
        // Update UI
        populateMenuButtons();
        displayMenuItems();
        
        const action = menuItems[index].status === 'active' ? 'enabled' : 'disabled';
        showToast(`Menu item ${action} successfully`, 'success');
        
    } catch (error) {
        console.error('Error toggling menu item status:', error);
        showToast('Error updating menu item status', 'error');
    }
}

function deleteMenuItem(index) {
    if (!menuItems[index]) return;
    
    if (confirm(`Are you sure you want to delete "${menuItems[index].name}"?`)) {
        menuItems.splice(index, 1);
        
        try {
            // Update in Firestore
            if (currentUser && currentUser.uid !== 'local-user-offline') {
                firebaseFirestore.collection('menuItems').doc(currentUser.uid).update({
                    items: menuItems,
                    lastUpdated: new Date().toISOString()
                });
            }
            
            // Save to localStorage
            saveLocalData();
            
            // Update UI
            populateMenuButtons();
            displayMenuItems();
            
            showToast('Menu item deleted successfully', 'success');
            
        } catch (error) {
            console.error('Error deleting menu item:', error);
            showToast('Error deleting menu item', 'error');
        }
    }
}

// ==================== SETTINGS FUNCTIONS ====================
function loadSettingsToUI() {
    if (!settings) return;
    
    document.getElementById('business-name').value = settings.businessName || "St. Margaret's Fish Bar";
    document.getElementById('business-address').value = settings.businessAddress || '';
    document.getElementById('business-phone').value = settings.businessPhone || '';
    document.getElementById('order-prefix').value = settings.orderPrefix || 'SMFB';
    document.getElementById('tax-rate').value = settings.taxRate || 20;
}

// ==================== UTILITY FUNCTIONS ====================
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    
    if (!toast || !toastMessage) {
        console.log('Toast notification:', message);
        return;
    }
    
    toastMessage.textContent = message;
    toast.className = `toast ${type}`;
    toast.style.display = 'flex';
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.style.display = 'none';
        }, 300);
    }, 3000);
}

function showLoading(message) {
    const loading = document.createElement('div');
    loading.id = 'loading-overlay';
    loading.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    loading.innerHTML = `
        <div class="spinner"></div>
        <div style="color: var(--white); margin-top: 20px;">${message}</div>
    `;
    
    document.body.appendChild(loading);
}

function hideLoading() {
    const loading = document.getElementById('loading-overlay');
    if (loading) {
        loading.remove();
    }
}

function playNotificationSound() {
    if (!soundEnabled) return;
    
    try {
        const audio = document.getElementById('notification-sound');
        audio.currentTime = 0;
        audio.play().catch(e => console.log('Audio play failed:', e));
    } catch (e) {
        console.log('Sound error:', e);
    }
}

// ==================== AUTO REFRESH ====================
function startAutoRefresh() {
    clearAllIntervals();
    
    autoRefreshIntervals.dashboard = setInterval(() => {
        if (document.getElementById('dashboard')?.classList.contains('active')) {
            updateDashboard();
        }
    }, 30000);
    
    autoRefreshIntervals.kitchen = setInterval(() => {
        if (document.getElementById('kitchen')?.classList.contains('active')) {
            updateKitchenView();
        }
    }, 10000);
}

function clearAllIntervals() {
    Object.values(autoRefreshIntervals).forEach(interval => {
        if (interval) clearInterval(interval);
    });
    autoRefreshIntervals = {};
}

function stopAllTimers() {
    Object.values(cookingTimers).forEach(timer => {
        if (timer) clearInterval(timer);
    });
    Object.values(orderTimers).forEach(timer => {
        if (timer) clearInterval(timer);
    });
    cookingTimers = {};
    orderTimers = {};
}

// ==================== CHARTS ====================
function initializeCharts() {
    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart');
    if (!revenueCtx) return;
    
    const ctx = revenueCtx.getContext('2d');
    
    const last7Days = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        last7Days.push(date.toISOString().split('T')[0]);
    }
    
    const dailyRevenue = last7Days.map(date => {
        return orders
            .filter(o => o.timestamp && o.timestamp.split('T')[0] === date && o.status === 'completed')
            .reduce((sum, o) => sum + (o.total || 0), 0);
    });
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: last7Days.map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric' });
            }),
            datasets: [{
                label: 'Revenue (£)',
                data: dailyRevenue,
                backgroundColor: 'rgba(211, 47, 47, 0.7)',
                borderColor: 'rgba(211, 47, 47, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '£' + value;
                        }
                    }
                }
            }
        }
    });
    
    // Sales Chart
    const salesCtx = document.getElementById('salesChart');
    if (!salesCtx) return;
    
    const salesCtx2d = salesCtx.getContext('2d');
    
    const itemSales = {};
    orders.forEach(order => {
        if (order.status === 'completed' && order.items) {
            order.items.forEach(item => {
                const itemName = item.name || 'Unknown';
                if (!itemSales[itemName]) {
                    itemSales[itemName] = 0;
                }
                itemSales[itemName] += (item.quantity || 0);
            });
        }
    });
    
    const topItems = Object.entries(itemSales)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);
    
    new Chart(salesCtx2d, {
        type: 'doughnut',
        data: {
            labels: topItems.map(item => item[0]),
            datasets: [{
                label: 'Items Sold',
                data: topItems.map(item => item[1]),
                backgroundColor: [
                    '#d32f2f', '#ff5722', '#ff9800', '#4caf50',
                    '#2196f3', '#9c27b0', '#795548', '#607d8b'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });
}

// ==================== EVENT LISTENERS ====================
function initEventListeners() {
    // Login
    document.getElementById('login-btn').addEventListener('click', firebaseLogin);
    document.getElementById('register-btn').addEventListener('click', registerNewAccount);
    document.getElementById('offline-mode-btn').addEventListener('click', useOfflineMode);
    document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') firebaseLogin();
    });
    
    // Logout
    document.getElementById('logout-link').addEventListener('click', function(e) {
        e.preventDefault();
        firebaseLogout();
    });
    
    // Tabs with safe element checking
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            
            // Check if tab content exists
            const tabContent = document.getElementById(tabId);
            if (!tabContent) {
                console.error(`Tab content not found: ${tabId}`);
                return;
            }
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Show corresponding content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            tabContent.classList.add('active');
            
            // Initialize tab-specific content
            switch(tabId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'orders':
                    displayOrders();
                    break;
                case 'kitchen':
                    updateKitchenView();
                    break;
                case 'staff':
                    if (typeof displayStaff === 'function') displayStaff();
                    break;
                case 'menu':
                    if (typeof displayMenuItems === 'function') displayMenuItems();
                    break;
                case 'settings':
                    // Settings tab loaded automatically
                    break;
            }
        });
    });
    
    // Sub-tabs
    document.querySelectorAll('.sub-tab').forEach(subTab => {
        subTab.addEventListener('click', function() {
            const subtabId = this.dataset.subtab;
            
            // Update active sub-tab
            document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Show corresponding content
            document.querySelectorAll('.sub-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const subtabContent = document.getElementById(subtabId);
            if (subtabContent) {
                subtabContent.classList.add('active');
            }
        });
    });
    
    // Order actions (delegated events)
    document.addEventListener('click', function(e) {
        // Order status buttons
        if (e.target.classList.contains('approve-btn') || e.target.closest('.approve-btn')) {
            const btn = e.target.classList.contains('approve-btn') ? e.target : e.target.closest('.approve-btn');
            const orderId = btn.dataset.id;
            if (orderId) updateOrderStatus(orderId, 'preparing');
        }
        
        if (e.target.classList.contains('ready-btn') || e.target.closest('.ready-btn')) {
            const btn = e.target.classList.contains('ready-btn') ? e.target : e.target.closest('.ready-btn');
            const orderId = btn.dataset.id;
            if (orderId) updateOrderStatus(orderId, 'ready');
        }
        
        if (e.target.classList.contains('complete-btn') || e.target.closest('.complete-btn')) {
            const btn = e.target.classList.contains('complete-btn') ? e.target : e.target.closest('.complete-btn');
            const orderId = btn.dataset.id;
            if (orderId) updateOrderStatus(orderId, 'completed');
        }
        
        if (e.target.classList.contains('cancel-btn') || e.target.closest('.cancel-btn')) {
            const btn = e.target.classList.contains('cancel-btn') ? e.target : e.target.closest('.cancel-btn');
            const orderId = btn.dataset.id;
            if (orderId && confirm('Are you sure you want to cancel this order?')) {
                updateOrderStatus(orderId, 'cancelled');
            }
        }
    });
    
    // New order
    document.getElementById('submit-order').addEventListener('click', createNewOrder);
    document.getElementById('clear-order').addEventListener('click', function() {
        selectedOrderItems = [];
        updateSelectedItemsDisplay();
        updateOrderTotal();
    });
    
    // Filters
    const applyFiltersBtn = document.getElementById('apply-filters');
    if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', displayOrders);
    }
    
    const clearFiltersBtn = document.getElementById('clear-filters');
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-type').value = 'all';
            document.getElementById('filter-status').value = 'all';
            displayOrders();
        });
    }
    
    // Refresh buttons with null checks
    const refreshDashboardBtn = document.getElementById('refresh-dashboard');
    if (refreshDashboardBtn) {
        refreshDashboardBtn.addEventListener('click', updateDashboard);
    }
    
    const refreshOrdersBtn = document.getElementById('refresh-orders');
    if (refreshOrdersBtn) {
        refreshOrdersBtn.addEventListener('click', displayOrders);
    }
    
    const refreshKitchenBtn = document.getElementById('refresh-kitchen');
    if (refreshKitchenBtn) {
        refreshKitchenBtn.addEventListener('click', updateKitchenView);
    }
    
    const refreshStaffBtn = document.getElementById('refresh-staff');
    if (refreshStaffBtn) {
        refreshStaffBtn.addEventListener('click', displayStaff);
    }
    
    const refreshMenuBtn = document.getElementById('refresh-menu');
    if (refreshMenuBtn) {
        refreshMenuBtn.addEventListener('click', displayMenuItems);
    }
    
    // Staff management
    document.getElementById('add-staff-btn').addEventListener('click', openStaffModal);
    document.getElementById('save-staff').addEventListener('click', saveStaffMember);
    document.getElementById('cancel-staff').addEventListener('click', function() {
        document.getElementById('staff-modal').style.display = 'none';
    });
    document.getElementById('close-staff-modal').addEventListener('click', function() {
        document.getElementById('staff-modal').style.display = 'none';
    });
    
    // Menu management
    const addMenuItemBtn = document.getElementById('add-menu-item');
    if (addMenuItemBtn) {
        addMenuItemBtn.addEventListener('click', openMenuModal);
    }
    
    const saveMenuItemBtn = document.getElementById('save-menu-item');
    if (saveMenuItemBtn) {
        saveMenuItemBtn.addEventListener('click', function() {
            const modal = document.getElementById('menu-modal');
            if (!modal) return;
            
            const isEdit = modal.dataset.editIndex !== undefined;
            if (isEdit) {
                updateMenuItem();
            } else {
                saveMenuItemFromModal();
            }
        });
    }
    
    const cancelMenuItemBtn = document.getElementById('cancel-menu-item');
    if (cancelMenuItemBtn) {
        cancelMenuItemBtn.addEventListener('click', function() {
            const modal = document.getElementById('menu-modal');
            if (modal) {
                modal.style.display = 'none';
                delete modal.dataset.editIndex;
            }
        });
    }
    
    const closeMenuModalBtn = document.getElementById('close-menu-modal');
    if (closeMenuModalBtn) {
        closeMenuModalBtn.addEventListener('click', function() {
            const modal = document.getElementById('menu-modal');
            if (modal) {
                modal.style.display = 'none';
                delete modal.dataset.editIndex;
            }
        });
    }
    
    // Settings
    document.getElementById('save-settings').addEventListener('click', updateSettings);
    document.getElementById('backup-data').addEventListener('click', backupData);
    document.getElementById('restore-data').addEventListener('click', restoreData);
    
    // Sound toggle
    document.getElementById('sound-toggle').addEventListener('click', function() {
        soundEnabled = !soundEnabled;
        this.classList.toggle('active', soundEnabled);
        this.title = soundEnabled ? 'Sound notifications ON' : 'Sound notifications OFF';
        
        kitchenSettings.enableSound = soundEnabled;
        showToast(`Sound notifications ${soundEnabled ? 'enabled' : 'disabled'}`, 'info');
    });
    
    // Export
    document.getElementById('export-orders').addEventListener('click', function() {
        let csv = 'Order ID,Customer,Type,Items,Total,Status,Date\n';
        
        orders.forEach(order => {
            const itemCount = order.items ? order.items.reduce((sum, item) => sum + (item.quantity || 0), 0) : 0;
            const date = order.timestamp ? new Date(order.timestamp).toLocaleDateString('en-GB') : 'N/A';
            
            csv += `"${order.id || 'N/A'}","${order.customer || 'Unknown'}","${formatOrderType(order.type)}",${itemCount},£${(order.total || 0).toFixed(2)},"${order.status || 'pending'}","${date}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `orders-export-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('Orders exported to CSV', 'success');
    });
}

// ==================== GLOBAL FUNCTIONS ====================
window.adjustQuantity = function(index, change) {
    adjustQuantity(index, change);
};

window.removeItemFromOrder = function(index) {
    removeItemFromOrder(index);
};

window.addTimeToOrder = function(orderId, minutes) {
    // This would update the order timestamp in Firestore
    showToast('Feature coming soon', 'info');
};

window.editStaff = function(staffId) {
    const member = staff.find(s => s.id === staffId) || staff[staffId];
    if (!member) return;
    
    document.getElementById('modal-title').textContent = 'Edit Staff';
    document.getElementById('staff-name').value = member.name || '';
    document.getElementById('staff-role').value = member.role || 'Server';
    document.getElementById('staff-phone').value = member.phone || '';
    document.getElementById('staff-rate').value = (parseFloat(member.hourlyRate) || 10.50).toFixed(2);
    
    document.getElementById('staff-modal').dataset.editId = staffId;
    document.getElementById('staff-modal').style.display = 'flex';
};

window.toggleStaffStatus = function(staffId) {
    const member = staff.find(s => s.id === staffId) || staff[staffId];
    if (!member) return;
    
    const newStatus = !(member.active !== false);
    member.active = newStatus;
    
    updateStaff(staffId, { active: newStatus });
    
    const action = newStatus ? 'activated' : 'deactivated';
    showToast(`Staff member ${action} successfully`, 'success');
};

window.deleteStaff = function(staffId) {
    if (confirm('Are you sure you want to delete this staff member?')) {
        deleteStaff(staffId);
    }
};

window.editMenuItem = function(index) {
    editMenuItem(index);
};

window.toggleMenuItemStatus = function(index) {
    toggleMenuItemStatus(index);
};

window.deleteMenuItem = function(index) {
    deleteMenuItem(index);
};

// ==================== BACKUP FUNCTIONS ====================
function backupData() {
    const allData = {
        orders: orders,
        staff: staff,
        menuItems: menuItems,
        settings: settings,
        exportedAt: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(allData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `fishbar-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('Backup created successfully', 'success');
}

function restoreData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const backupData = JSON.parse(e.target.result);
                
                if (confirm('This will replace all current data. Are you sure?')) {
                    orders = backupData.orders || [];
                    staff = backupData.staff || [];
                    menuItems = backupData.menuItems || getDefaultMenuItems();
                    settings = backupData.settings || getDefaultSettings();
                    
                    saveLocalData();
                    
                    updateDashboard();
                    displayOrders();
                    displayStaff();
                    displayMenuItems();
                    loadSettingsToUI();
                    populateMenuButtons();
                    
                    showToast('Data restored successfully', 'success');
                }
            } catch (error) {
                showToast('Error restoring backup: Invalid file format', 'error');
            }
        };
        
        reader.readAsText(file);
    };
    
    input.click();
}

// ==================== INITIALIZE ====================
console.log('Fish Bar Management System v2.0 Initialized');
</script>
</body>
</html>
