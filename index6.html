<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>St. Margaret's Fish Bar - Complete Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-storage-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-red: #d32f2f;
            --dark-red: #b71c1c;
            --light-red: #ff6659;
            --black: #121212;
            --dark-gray: #212121;
            --gray: #424242;
            --light-gray: #757575;
            --white: #ffffff;
            --off-white: #f5f5f5;
            --success: #4caf50;
            --warning: #ff9800;
            --info: #2196f3;
            --kitchen-orange: #ff5722;
            --delivery-blue: #2196f3;
            --admin-purple: #9c27b0;
            --manager-blue: #2196f3;
            --chef-green: #4caf50;
            --staff-blue: #2196f3;
        }
        
        body {
            background-color: var(--black);
            color: var(--off-white);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.9));
        }
        
        .login-box {
            background-color: var(--dark-gray);
            border-radius: 10px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            border-top: 5px solid var(--primary-red);
        }
        
        .login-box h2 {
            text-align: center;
            color: var(--white);
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .login-subtitle {
            text-align: center;
            color: var(--light-gray);
            margin-bottom: 30px;
            font-size: 1rem;
        }
        
        .login-error {
            background-color: rgba(211, 47, 47, 0.2);
            color: var(--light-red);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        /* Header */
        header {
            background-color: var(--black);
            color: var(--white);
            padding: 1.2rem 0;
            box-shadow: 0 3px 15px rgba(0,0,0,0.5);
            border-bottom: 3px solid var(--primary-red);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            color: var(--primary-red);
        }
        
        .logo-text h1 {
            font-size: 1.6rem;
            margin-bottom: 5px;
            color: var(--white);
        }
        
        .logo-text p {
            color: var(--light-gray);
            font-size: 0.8rem;
            letter-spacing: 1px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info span {
            color: var(--light-gray);
        }
        
        .logout-btn {
            background-color: var(--dark-gray);
            color: var(--white);
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .logout-btn:hover {
            background-color: var(--primary-red);
        }
        
        /* Navigation Tabs */
        .tabs {
            display: flex;
            background-color: var(--dark-gray);
            border-bottom: 2px solid var(--primary-red);
            overflow-x: auto;
        }
        
        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            color: var(--light-gray);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            border-right: 1px solid var(--gray);
        }
        
        .tab.active {
            background-color: var(--primary-red);
            color: var(--white);
        }
        
        .tab:hover:not(.active) {
            background-color: var(--gray);
            color: var(--white);
        }
        
        /* Main Content */
        .main-content {
            padding: 30px 0;
            min-height: calc(100vh - 180px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-left: 5px solid var(--primary-red);
        }
        
        .card h3 {
            font-size: 1rem;
            color: var(--light-gray);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 5px;
        }
        
        .card .trend {
            font-size: 0.9rem;
            color: var(--light-gray);
        }
        
        .card .trend.up {
            color: var(--success);
        }
        
        .card .trend.down {
            color: var(--primary-red);
        }
        
        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-box {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .chart-box h3 {
            color: var(--white);
            margin-bottom: 20px;
            font-size: 1.3rem;
            border-bottom: 2px solid var(--primary-red);
            padding-bottom: 10px;
        }
        
        /* Tables */
        .table-container {
            background-color: var(--dark-gray);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background-color: var(--primary-red);
        }
        
        th {
            padding: 15px;
            text-align: left;
            color: var(--white);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        tbody tr {
            border-bottom: 1px solid var(--gray);
            transition: background-color 0.3s;
        }
        
        tbody tr:hover {
            background-color: var(--gray);
        }
        
        td {
            padding: 15px;
            color: var(--off-white);
        }
        
        /* Forms */
        .form-container {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--white);
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--black);
            border: 1px solid var(--gray);
            border-radius: 5px;
            color: var(--white);
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-red);
        }
        
        .btn {
            padding: 12px 25px;
            background-color: var(--primary-red);
            color: var(--white);
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .btn:hover {
            background-color: var(--dark-red);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--gray);
        }
        
        .btn-secondary:hover {
            background-color: var(--light-gray);
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #3d8b40;
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        .btn-warning:hover {
            background-color: #e68900;
        }
        
        .btn-info {
            background-color: var(--info);
        }
        
        .btn-info:hover {
            background-color: #0b7dda;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        /* Orders Grid */
        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .order-card {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-left: 5px solid var(--primary-red);
        }
        
        .order-card.pending {
            border-left: 5px solid var(--warning);
        }
        
        .order-card.preparing {
            border-left: 5px solid var(--kitchen-orange);
        }
        
        .order-card.ready {
            border-left: 5px solid var(--success);
        }
        
        .order-card.completed {
            border-left: 5px solid var(--info);
        }
        
        .order-card.cancelled {
            border-left: 5px solid var(--light-gray);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray);
        }
        
        .order-id {
            font-weight: 700;
            color: var(--white);
            font-size: 1.2rem;
        }
        
        .order-time {
            color: var(--light-gray);
            font-size: 0.9rem;
        }
        
        .order-items {
            margin-bottom: 20px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--gray);
        }
        
        .order-total {
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--white);
            padding-top: 15px;
            border-top: 2px solid var(--gray);
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-preparing {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-ready {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* Kitchen Orders Grid */
        .kitchen-orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .kitchen-order-card {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border-left: 5px solid var(--kitchen-orange);
            position: relative;
        }
        
        .kitchen-order-card.urgent {
            border-left: 5px solid var(--primary-red);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 87, 34, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0); }
        }
        
        .kitchen-order-card.ready {
            border-left: 5px solid var(--success);
        }
        
        .timer-display {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--kitchen-orange);
        }
        
        .timer-display.warning {
            color: var(--warning);
        }
        
        .timer-display.danger {
            color: var(--primary-red);
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Filters */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: var(--dark-gray);
            border-radius: 8px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        /* Reports */
        .report-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: var(--dark-gray);
            border-radius: 8px;
        }
        
        .report-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .report-card {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .report-card h4 {
            color: var(--light-gray);
            margin-bottom: 15px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .report-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 10px;
        }
        
        .report-details {
            font-size: 0.9rem;
            color: var(--light-gray);
        }
        
        /* Attendance */
        .attendance-container {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .attendance-card {
            background-color: var(--black);
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid var(--info);
        }
        
        .attendance-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .status-present {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-absent {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-late {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .attendance-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Payroll */
        .payroll-container {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .payroll-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .payroll-item {
            background-color: var(--black);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        /* Recipes */
        .recipes-container {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .recipe-card {
            background-color: var(--black);
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid var(--success);
        }
        
        .ingredients-list {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .ingredients-list li {
            margin-bottom: 5px;
        }
        
        /* Time Clock */
        .time-clock {
            background-color: var(--dark-gray);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .current-time {
            font-size: 3rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 20px;
        }
        
        .clock-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            margin: 0 10px;
            min-width: 150px;
        }
        
        .clock-in-btn {
            background-color: var(--success);
        }
        
        .clock-out-btn {
            background-color: var(--primary-red);
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--dark-gray);
            color: var(--white);
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left: 4px solid var(--success);
        }
        
        .toast.error {
            border-left: 4px solid var(--primary-red);
        }
        
        .toast.warning {
            border-left: 4px solid var(--warning);
        }
        
        .toast.info {
            border-left: 4px solid var(--info);
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary-red);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Connection Status */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .connection-online {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }
        
        .connection-offline {
            background-color: rgba(211, 47, 47, 0.2);
            color: var(--primary-red);
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .connection-online .connection-dot {
            background-color: var(--success);
            animation: pulse 2s infinite;
        }
        
        .connection-offline .connection-dot {
            background-color: var(--primary-red);
        }
        
        /* Role-based Colors */
        .role-admin { color: var(--admin-purple); }
        .role-manager { color: var(--manager-blue); }
        .role-chef { color: var(--chef-green); }
        .role-staff { color: var(--info); }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
        
        /* Responsive */
        @media (max-width: 1100px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .tabs {
                overflow-x: scroll;
            }
            
            .tab {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .dashboard-cards {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .card .value {
                font-size: 2rem;
            }
            
            .orders-grid, .kitchen-orders-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-box {
                padding: 15px;
            }
        }
        
        @media (max-width: 576px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .filters, .report-filters {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--black);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-red);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-red);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--dark-gray);
            padding: 30px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray);
        }
        
        .modal-title {
            color: var(--white);
            font-size: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--light-gray);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: var(--white);
        }
    </style>
</head>
<body>
    <!-- Audio for notifications -->
    <audio id="notification-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-kitchen-timer-1006.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span id="toast-message">Message</span>
    </div>
    
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <h2>St. Margaret's Fish Bar</h2>
            <p class="login-subtitle">Complete Management System v4.0</p>
            
            <div id="login-error" class="login-error">
                <i class="fas fa-exclamation-circle"></i>
                <span id="error-message">Error message</span>
            </div>
            
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="email" class="form-control" placeholder="Enter your email" autocomplete="username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password" autocomplete="current-password">
            </div>
            <div class="form-group">
                <button id="login-btn" class="btn" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Login to System
                </button>
            </div>
            <div class="form-group" style="text-align: center;">
                <button id="register-btn" class="btn btn-info" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-user-plus"></i> Register New Account
                </button>
                <p style="color: var(--light-gray); margin-top: 20px; font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> First time? Register an admin account
                </p>
            </div>
        </div>
    </div>
    
    <!-- Main Application -->
    <div id="app" style="display: none;">
        <!-- Header -->
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-fish"></i>
                        </div>
                        <div class="logo-text">
                            <h1>ST. MARGARET'S FISH BAR</h1>
                            <p id="user-role-display">MANAGEMENT SYSTEM</p>
                        </div>
                    </div>
                    
                    <div class="user-info">
                        <span id="current-user-display">Loading...</span>
                        <span id="current-date"></span>
                        <span id="connection-status" class="connection-status connection-online">
                            <span class="connection-dot"></span>
                            <span class="connection-text">Online</span>
                        </span>
                        <i class="fas fa-bell sound-toggle active" id="sound-toggle" title="Toggle notifications"></i>
                        <button id="logout-btn" class="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Navigation Tabs -->
        <div class="tabs" id="main-tabs">
            <!-- Tabs will be loaded based on user role -->
        </div>
        
        <!-- Main Content -->
        <div class="container main-content">
            <!-- All tab content will be loaded dynamically -->
            <div id="tab-content-container"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="staff-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Add Staff Member</h3>
                <button class="close-modal" id="close-staff-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="staff-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Email Address *</label>
                    <input type="email" id="staff-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="staff-role" class="form-control" required>
                        <option value="manager">Manager</option>
                        <option value="chef">Chef</option>
                        <option value="kitchen_staff">Kitchen Staff</option>
                        <option value="server">Server</option>
                        <option value="delivery">Delivery Driver</option>
                        <option value="cleaner">Cleaner</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" id="staff-phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Hourly Rate (£) *</label>
                    <input type="number" id="staff-rate" class="form-control" step="0.01" min="0" value="10.50" required>
                </div>
                <div class="form-group">
                    <label>Password (for login) *</label>
                    <input type="password" id="staff-password" class="form-control" required>
                </div>
                <div class="d-flex gap-10 mt-20">
                    <button id="save-staff-btn" class="btn">Save Staff Member</button>
                    <button id="cancel-staff" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="menu-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="menu-modal-title">Add Menu Item</h3>
                <button class="close-modal" id="close-menu-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Item Name *</label>
                    <input type="text" id="menu-item-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Category *</label>
                    <select id="menu-item-category" class="form-control" required>
                        <option value="Fish">Fish</option>
                        <option value="Sausages">Sausages</option>
                        <option value="Pies">Pies</option>
                        <option value="Burgers">Burgers</option>
                        <option value="Sides">Sides</option>
                        <option value="Specials">Specials</option>
                        <option value="BBQ Chicken">BBQ Chicken</option>
                        <option value="Drinks">Drinks</option>
                        <option value="Desserts">Desserts</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Price (£) *</label>
                    <input type="number" id="menu-item-price" class="form-control" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Cost (£) *</label>
                    <input type="number" id="menu-item-cost" class="form-control" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Cooking Time (minutes) *</label>
                    <input type="number" id="menu-item-cooktime" class="form-control" min="1" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="menu-item-description" class="form-control" rows="3"></textarea>
                </div>
                <div class="d-flex gap-10 mt-20">
                    <button id="save-menu-item-btn" class="btn">Save Menu Item</button>
                    <button id="cancel-menu-item" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Order</h3>
                <button class="close-modal" id="close-order-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Order Type *</label>
                    <select id="order-type" class="form-control" required>
                        <option value="walk-in">Walk-in</option>
                        <option value="just-eat">Just Eat</option>
                        <option value="deliveroo">Deliveroo</option>
                        <option value="uber-eats">Uber Eats</option>
                        <option value="phone">Phone Order</option>
                        <option value="online">Online Order</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" id="customer-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Customer Phone</label>
                    <input type="tel" id="customer-phone" class="form-control">
                </div>
                <div class="form-group">
                    <label>Delivery Address (if delivery)</label>
                    <textarea id="delivery-address" class="form-control" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Select Menu Items</label>
                    <div id="menu-items-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 10px; padding: 10px; background-color: var(--black); border-radius: 5px;">
                        <!-- Menu items will be loaded here -->
                    </div>
                    <div id="selected-items" style="background-color: var(--black); padding: 15px; border-radius: 5px; min-height: 100px; margin-top: 10px;">
                        <p style="color: var(--light-gray); text-align: center;">No items selected</p>
                    </div>
                </div>
                <div class="form-group">
                    <label>Total Amount</label>
                    <input type="text" id="order-total" class="form-control" value="£0.00" readonly>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="payment-method" class="form-control">
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="just-eat">Just Eat</option>
                        <option value="deliveroo">Deliveroo</option>
                        <option value="uber-eats">Uber Eats</option>
                        <option value="online">Online Payment</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes/Instructions</label>
                    <textarea id="order-notes" class="form-control" rows="3"></textarea>
                </div>
                <div class="d-flex gap-10">
                    <button id="submit-order-btn" class="btn">Submit Order</button>
                    <button id="clear-order-form" class="btn btn-secondary">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <div id="attendance-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Mark Attendance</h3>
                <button class="close-modal" id="close-attendance-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Staff Member</label>
                    <select id="attendance-staff" class="form-control">
                        <!-- Staff will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="attendance-date" class="form-control" value="<?php echo date('Y-m-d'); ?>">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="attendance-status" class="form-control">
                        <option value="present">Present</option>
                        <option value="absent">Absent</option>
                        <option value="late">Late</option>
                        <option value="sick">Sick Leave</option>
                        <option value="vacation">Vacation</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Clock In Time</label>
                    <input type="time" id="clock-in-time" class="form-control" value="09:00">
                </div>
                <div class="form-group">
                    <label>Clock Out Time</label>
                    <input type="time" id="clock-out-time" class="form-control" value="17:00">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="attendance-notes" class="form-control" rows="3"></textarea>
                </div>
                <div class="d-flex gap-10">
                    <button id="save-attendance-btn" class="btn">Save Attendance</button>
                    <button id="cancel-attendance" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="payroll-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Process Payroll</h3>
                <button class="close-modal" id="close-payroll-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Pay Period</label>
                    <select id="payroll-period" class="form-control">
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="payroll-start-date" class="form-control" value="<?php echo date('Y-m-d', strtotime('-7 days')); ?>">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="payroll-end-date" class="form-control" value="<?php echo date('Y-m-d'); ?>">
                </div>
                <div class="form-group">
                    <label>Staff Member</label>
                    <select id="payroll-staff" class="form-control">
                        <!-- Staff will be loaded here -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Total Hours Worked</label>
                    <input type="number" id="total-hours" class="form-control" step="0.1" min="0">
                </div>
                <div class="form-group">
                    <label>Overtime Hours</label>
                    <input type="number" id="overtime-hours" class="form-control" step="0.1" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Bonus Amount (£)</label>
                    <input type="number" id="bonus-amount" class="form-control" step="0.01" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Deductions (£)</label>
                    <input type="number" id="deductions" class="form-control" step="0.01" min="0" value="0">
                </div>
                <div class="d-flex gap-10">
                    <button id="calculate-payroll-btn" class="btn btn-success">Calculate Payroll</button>
                    <button id="process-payment-btn" class="btn">Process Payment</button>
                    <button id="cancel-payroll" class="btn btn-secondary">Cancel</button>
                </div>
                <div id="payroll-result" class="mt-20" style="display: none;">
                    <h4 style="color: var(--white); margin-bottom: 10px;">Payroll Calculation</h4>
                    <div style="background-color: var(--black); padding: 15px; border-radius: 5px;">
                        <p><strong>Basic Salary:</strong> £<span id="basic-salary">0.00</span></p>
                        <p><strong>Overtime Pay:</strong> £<span id="overtime-pay">0.00</span></p>
                        <p><strong>Bonus:</strong> £<span id="bonus-pay">0.00</span></p>
                        <p><strong>Deductions:</strong> £<span id="total-deductions">0.00</span></p>
                        <p><strong>Net Pay:</strong> £<span id="net-pay">0.00</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
// ==================== COMPLETE PRODUCTION RESTAURANT MANAGEMENT SYSTEM ====================
// ==================== GLOBAL VARIABLES ====================
let currentUser = null;
let currentUserRole = null;
let currentUserData = null;
let orders = [];
let staff = [];
let menuItems = [];
let attendance = [];
let payroll = [];
let recipes = [];
let inventory = [];
let selectedOrderItems = [];
let firebaseApp = null;
let firebaseAuth = null;
let firebaseFirestore = null;
let onlineStatus = true;
let realtimeListeners = {};
let autoRefreshIntervals = {};
let soundEnabled = true;
let currentTab = 'dashboard';
let charts = {};

// ==================== FIREBASE CONFIGURATION ====================
const firebaseConfig = {
    apiKey: "AIzaSyD1v90S_vkiS0CyZYs9Xmwsi5N_G5Nw7JQ",
    authDomain: "fishhub-5df1e.firebaseapp.com",
    projectId: "fishhub-5df1e",
    storageBucket: "fishhub-5df1e.firebasestorage.app",
    messagingSenderId: "360759181280",
    appId: "1:360759181280:web:0b730ac1d442546b393585",
    measurementId: "G-SF2WNZQF6D"
};

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    initializeFirebase();
    initEventListeners();
    updateCurrentDate();
});

function initializeFirebase() {
    try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        firebaseAuth = firebaseApp.auth();
        firebaseFirestore = firebaseApp.firestore();
        
        console.log('Firebase initialized successfully');
        
        // Setup auth state listener
        firebaseAuth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('User signed in:', user.email);
                currentUser = user;
                
                // Get user data from Firestore
                await loadUserData();
                
                if (currentUserData) {
                    showApp();
                    setupRealtimeListeners();
                    loadInitialData();
                } else {
                    showToast('Error loading user data', 'error');
                    await firebaseAuth.signOut();
                }
            } else {
                console.log('User signed out');
                currentUser = null;
                currentUserData = null;
                showLoginScreen();
            }
        });
        
    } catch (error) {
        console.log('Firebase initialization error:', error);
        showToast('Firebase initialization failed. Please check your connection.', 'error');
    }
}

async function loadUserData() {
    try {
        const userDoc = await firebaseFirestore.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
            currentUserData = userDoc.data();
            currentUserRole = currentUserData.role;
            console.log('User role:', currentUserRole);
        } else {
            // If user doesn't exist in Firestore, create a basic record
            currentUserData = {
                email: currentUser.email,
                role: 'admin', // Default to admin for first user
                name: currentUser.email.split('@')[0],
                createdAt: new Date().toISOString()
            };
            
            await firebaseFirestore.collection('users').doc(currentUser.uid).set(currentUserData);
            currentUserRole = 'admin';
        }
        
        return true;
    } catch (error) {
        console.error('Error loading user data:', error);
        return false;
    }
}

// ==================== AUTHENTICATION ====================
async function firebaseLogin() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
        showLoginError('Please enter email and password');
        return;
    }
    
    showLoading('Logging in...');
    
    try {
        const userCredential = await firebaseAuth.signInWithEmailAndPassword(email, password);
        currentUser = userCredential.user;
        showToast('Login successful!', 'success');
        
    } catch (error) {
        console.error('Login error:', error);
        
        if (error.code === 'auth/user-not-found') {
            showLoginError('Account not found. Please register first.');
        } else if (error.code === 'auth/wrong-password') {
            showLoginError('Incorrect password');
        } else if (error.code === 'auth/invalid-email') {
            showLoginError('Invalid email address');
        } else if (error.code === 'auth/too-many-requests') {
            showLoginError('Too many failed attempts. Please try again later.');
        } else {
            showLoginError(`Login failed: ${error.message}`);
        }
        
        hideLoading();
    }
}

async function registerAccount() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
        showLoginError('Please enter email and password');
        return;
    }
    
    if (password.length < 6) {
        showLoginError('Password must be at least 6 characters');
        return;
    }
    
    showLoading('Creating account...');
    
    try {
        // First check if any users exist
        const usersSnapshot = await firebaseFirestore.collection('users').limit(1).get();
        const isFirstUser = usersSnapshot.empty;
        
        // Create user in Firebase Auth
        const userCredential = await firebaseAuth.createUserWithEmailAndPassword(email, password);
        currentUser = userCredential.user;
        
        // Create user document in Firestore
        const userData = {
            email: email,
            role: isFirstUser ? 'admin' : 'staff', // First user becomes admin
            name: email.split('@')[0],
            createdAt: new Date().toISOString(),
            active: true
        };
        
        await firebaseFirestore.collection('users').doc(currentUser.uid).set(userData);
        currentUserData = userData;
        currentUserRole = userData.role;
        
        // Initialize default data for admin
        if (isFirstUser) {
            await initializeDefaultData();
        }
        
        showToast('Account created successfully!', 'success');
        
    } catch (error) {
        console.error('Registration error:', error);
        
        if (error.code === 'auth/email-already-in-use') {
            showLoginError('Email already registered');
        } else if (error.code === 'auth/invalid-email') {
            showLoginError('Invalid email address');
        } else if (error.code === 'auth/weak-password') {
            showLoginError('Password is too weak');
        } else {
            showLoginError(`Registration failed: ${error.message}`);
        }
        
        hideLoading();
    }
}

async function initializeDefaultData() {
    try {
        // Default menu items
        const defaultMenu = [
            { id: generateId(), name: "Cod & Chips", category: "Fish", price: 7.50, cost: 3.00, cookTime: 8, status: "active", createdAt: new Date().toISOString() },
            { id: generateId(), name: "Haddock & Chips", category: "Fish", price: 8.50, cost: 3.50, cookTime: 8, status: "active", createdAt: new Date().toISOString() },
            { id: generateId(), name: "Battered Sausage & Chips", category: "Sausages", price: 4.50, cost: 1.50, cookTime: 5, status: "active", createdAt: new Date().toISOString() },
            { id: generateId(), name: "Steak Pie & Chips", category: "Pies", price: 5.50, cost: 2.00, cookTime: 12, status: "active", createdAt: new Date().toISOString() },
            { id: generateId(), name: "Cheeseburger & Chips", category: "Burgers", price: 6.50, cost: 2.50, cookTime: 10, status: "active", createdAt: new Date().toISOString() },
            { id: generateId(), name: "Chips", category: "Sides", price: 3.00, cost: 0.80, cookTime: 6, status: "active", createdAt: new Date().toISOString() },
            { id: generateId(), name: "Mushy Peas", category: "Sides", price: 1.80, cost: 0.50, cookTime: 3, status: "active", createdAt: new Date().toISOString() },
            { id: generateId(), name: "BBQ Chicken Half", category: "BBQ Chicken", price: 5.50, cost: 2.00, cookTime: 15, status: "active", createdAt: new Date().toISOString() }
        ];
        
        // Save to Firestore
        for (const item of defaultMenu) {
            await firebaseFirestore.collection('menuItems').doc(item.id).set(item);
        }
        
        // Default settings
        const settings = {
            businessName: "St. Margaret's Fish Bar",
            businessAddress: "123 Seafood Street, Coastal Town",
            businessPhone: "01234 567890",
            taxRate: 20,
            orderPrefix: "SMFB",
            createdAt: new Date().toISOString()
        };
        
        await firebaseFirestore.collection('settings').doc('main').set(settings);
        
        console.log('Default data initialized');
        
    } catch (error) {
        console.error('Error initializing default data:', error);
    }
}

async function firebaseLogout() {
    try {
        // Stop all realtime listeners
        Object.values(realtimeListeners).forEach(unsubscribe => {
            if (typeof unsubscribe === 'function') unsubscribe();
        });
        realtimeListeners = {};
        
        // Clear intervals
        clearAllIntervals();
        
        // Sign out
        await firebaseAuth.signOut();
        
        currentUser = null;
        currentUserData = null;
        currentUserRole = null;
        
        showToast('Logged out successfully', 'info');
        
    } catch (error) {
        console.error('Logout error:', error);
        showToast('Error during logout', 'error');
    }
}

// ==================== UI FUNCTIONS ====================
function showLoginScreen() {
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('app').style.display = 'none';
    hideLoginError();
}

function showApp() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    
    // Update user display
    document.getElementById('current-user-display').textContent = currentUserData.name || currentUserData.email;
    document.getElementById('user-role-display').textContent = currentUserRole.toUpperCase() + ' DASHBOARD';
    
    // Load appropriate tabs based on role
    loadNavigationTabs();
    
    // Load initial tab content
    loadTabContent('dashboard');
}

function loadNavigationTabs() {
    const tabsContainer = document.getElementById('main-tabs');
    tabsContainer.innerHTML = '';
    
    // Common tabs for all roles
    const commonTabs = [
        { id: 'dashboard', label: 'Dashboard', icon: 'tachometer-alt', roles: ['admin', 'manager', 'chef', 'kitchen_staff', 'server'] },
        { id: 'orders', label: 'Orders', icon: 'receipt', roles: ['admin', 'manager', 'chef', 'kitchen_staff', 'server'] },
        { id: 'kitchen', label: 'Kitchen View', icon: 'utensils', roles: ['admin', 'manager', 'chef', 'kitchen_staff'] },
    ];
    
    // Role-specific tabs
    const roleTabs = {
        admin: [
            { id: 'staff', label: 'Staff', icon: 'users', roles: ['admin', 'manager'] },
            { id: 'attendance', label: 'Attendance', icon: 'calendar-check', roles: ['admin', 'manager'] },
            { id: 'payroll', label: 'Payroll', icon: 'money-bill-wave', roles: ['admin', 'manager'] },
            { id: 'reports', label: 'Reports', icon: 'chart-bar', roles: ['admin', 'manager'] },
            { id: 'menu', label: 'Menu', icon: 'utensils', roles: ['admin', 'manager', 'chef'] },
            { id: 'inventory', label: 'Inventory', icon: 'box', roles: ['admin', 'manager', 'chef'] },
            { id: 'settings', label: 'Settings', icon: 'cog', roles: ['admin'] }
        ],
        manager: [
            { id: 'staff', label: 'Staff', icon: 'users', roles: ['admin', 'manager'] },
            { id: 'attendance', label: 'Attendance', icon: 'calendar-check', roles: ['admin', 'manager'] },
            { id: 'payroll', label: 'Payroll', icon: 'money-bill-wave', roles: ['admin', 'manager'] },
            { id: 'reports', label: 'Reports', icon: 'chart-bar', roles: ['admin', 'manager'] },
            { id: 'menu', label: 'Menu', icon: 'utensils', roles: ['admin', 'manager', 'chef'] },
            { id: 'inventory', label: 'Inventory', icon: 'box', roles: ['admin', 'manager', 'chef'] }
        ],
        chef: [
            { id: 'menu', label: 'Menu', icon: 'utensils', roles: ['admin', 'manager', 'chef'] },
            { id: 'inventory', label: 'Inventory', icon: 'box', roles: ['admin', 'manager', 'chef'] }
        ],
        kitchen_staff: [
            // Only common tabs
        ],
        server: [
            // Only common tabs
        ],
        delivery: [
            { id: 'delivery', label: 'Delivery', icon: 'truck', roles: ['admin', 'manager', 'delivery'] }
        ]
    };
    
    // Combine tabs based on role
    let allTabs = [...commonTabs];
    
    if (roleTabs[currentUserRole]) {
        allTabs = [...allTabs, ...roleTabs[currentUserRole]];
    }
    
    // Create tab buttons
    allTabs.forEach(tab => {
        if (tab.roles.includes(currentUserRole)) {
            const tabButton = document.createElement('button');
            tabButton.className = `tab ${tab.id === currentTab ? 'active' : ''}`;
            tabButton.dataset.tab = tab.id;
            tabButton.innerHTML = `<i class="fas fa-${tab.icon}"></i> ${tab.label}`;
            tabsContainer.appendChild(tabButton);
        }
    });
    
    // Add tab click event listeners
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            switchTab(tabId);
        });
    });
}

function switchTab(tabId) {
    currentTab = tabId;
    
    // Update active tab
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabId) {
            tab.classList.add('active');
        }
    });
    
    // Load tab content
    loadTabContent(tabId);
}

function loadTabContent(tabId) {
    const container = document.getElementById('tab-content-container');
    
    switch(tabId) {
        case 'dashboard':
            loadDashboard();
            break;
        case 'orders':
            loadOrdersTab();
            break;
        case 'kitchen':
            loadKitchenTab();
            break;
        case 'staff':
            loadStaffTab();
            break;
        case 'attendance':
            loadAttendanceTab();
            break;
        case 'payroll':
            loadPayrollTab();
            break;
        case 'reports':
            loadReportsTab();
            break;
        case 'menu':
            loadMenuTab();
            break;
        case 'inventory':
            loadInventoryTab();
            break;
        case 'settings':
            loadSettingsTab();
            break;
        default:
            container.innerHTML = '<div class="text-center"><h3>Coming Soon</h3></div>';
    }
}

// ==================== DASHBOARD ====================
async function loadDashboard() {
    const container = document.getElementById('tab-content-container');
    
    container.innerHTML = `
        <div class="d-flex justify-between align-center mb-30">
            <h2 style="color: var(--white); font-size: 1.8rem;">Dashboard Overview</h2>
            <div class="d-flex align-center">
                <span style="color: var(--light-gray); margin-right: 10px;">Auto-refresh: 30s</span>
                <div class="auto-refresh-indicator"></div>
            </div>
        </div>
        
        <div class="dashboard-cards">
            <div class="card">
                <h3>Today's Revenue</h3>
                <div class="value" id="today-revenue">£0.00</div>
                <div class="trend" id="today-trend">Loading...</div>
            </div>
            
            <div class="card">
                <h3>Active Orders</h3>
                <div class="value" id="active-orders">0</div>
                <div class="trend" id="orders-trend">Loading...</div>
            </div>
            
            <div class="card">
                <h3>Kitchen Queue</h3>
                <div class="value" id="kitchen-queue">0</div>
                <div class="trend" id="kitchen-trend">Loading...</div>
            </div>
            
            <div class="card">
                <h3>Staff On Duty</h3>
                <div class="value" id="staff-on-duty">0</div>
                <div class="trend" id="staff-trend">Loading...</div>
            </div>
        </div>
        
        <div class="charts-container">
            <div class="chart-box">
                <h3>Revenue This Week</h3>
                <canvas id="revenueChart"></canvas>
            </div>
            
            <div class="chart-box">
                <h3>Order Status</h3>
                <canvas id="ordersChart"></canvas>
            </div>
        </div>
        
        <div class="table-container">
            <div class="d-flex justify-between align-center" style="padding: 20px; border-bottom: 1px solid var(--gray);">
                <h3 style="color: var(--white);">Recent Orders</h3>
                <button id="refresh-dashboard" class="btn btn-small">Refresh</button>
            </div>
            <table id="recent-orders-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Type</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="recent-orders-body">
                    <tr><td colspan="7" style="text-align: center; padding: 30px;">Loading orders...</td></tr>
                </tbody>
            </table>
        </div>
    `;
    
    // Add event listeners
    document.getElementById('refresh-dashboard')?.addEventListener('click', updateDashboard);
    
    // Load data
    updateDashboard();
    initializeCharts();
    
    // Start auto-refresh
    startAutoRefresh();
}

function updateDashboard() {
    const today = new Date().toISOString().split('T')[0];
    
    // Calculate today's revenue
    const todayOrders = orders.filter(order => 
        order.createdAt?.split('T')[0] === today && 
        (order.status === 'completed' || order.status === 'ready')
    );
    
    const todayRevenue = todayOrders.reduce((sum, order) => sum + (order.total || 0), 0);
    document.getElementById('today-revenue').textContent = `£${todayRevenue.toFixed(2)}`;
    
    // Active orders
    const activeOrders = orders.filter(order => 
        order.status === 'pending' || order.status === 'preparing'
    );
    document.getElementById('active-orders').textContent = activeOrders.length;
    
    // Kitchen queue
    const kitchenQueue = orders.filter(order => order.status === 'preparing');
    document.getElementById('kitchen-queue').textContent = kitchenQueue.length;
    
    // Staff on duty
    const todayAttendance = attendance.filter(record => 
        record.date === today && record.status === 'present'
    );
    document.getElementById('staff-on-duty').textContent = todayAttendance.length;
    
    // Update recent orders table
    updateRecentOrdersTable();
}

function updateRecentOrdersTable() {
    const tbody = document.getElementById('recent-orders-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const recentOrders = [...orders]
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
        .slice(0, 10);
    
    if (recentOrders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">No orders yet</td></tr>';
        return;
    }
    
    recentOrders.forEach(order => {
        const orderDate = new Date(order.createdAt);
        const timeString = orderDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const dateString = orderDate.toLocaleDateString('en-GB');
        const itemCount = order.items ? order.items.reduce((sum, item) => sum + (item.quantity || 1), 0) : 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${order.orderNumber || order.id}</td>
            <td>${order.customerName || 'N/A'}</td>
            <td>${order.type || 'N/A'}</td>
            <td>${itemCount} items</td>
            <td>£${(order.total || 0).toFixed(2)}</td>
            <td><span class="status-badge status-${order.status || 'pending'}">${order.status || 'pending'}</span></td>
            <td>${timeString}</td>
        `;
        tbody.appendChild(row);
    });
}

function initializeCharts() {
    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx) {
        // Destroy existing chart
        if (charts.revenueChart) {
            charts.revenueChart.destroy();
        }
        
        // Get last 7 days data
        const last7Days = [];
        const revenueData = [];
        
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            last7Days.push(date.toLocaleDateString('en-GB', { weekday: 'short' }));
            
            const dayRevenue = orders
                .filter(order => 
                    order.createdAt?.split('T')[0] === dateStr && 
                    (order.status === 'completed' || order.status === 'ready')
                )
                .reduce((sum, order) => sum + (order.total || 0), 0);
            
            revenueData.push(dayRevenue);
        }
        
        charts.revenueChart = new Chart(revenueCtx, {
            type: 'bar',
            data: {
                labels: last7Days,
                datasets: [{
                    label: 'Revenue (£)',
                    data: revenueData,
                    backgroundColor: 'rgba(211, 47, 47, 0.7)',
                    borderColor: 'rgba(211, 47, 47, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '£' + value;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Orders Chart
    const ordersCtx = document.getElementById('ordersChart');
    if (ordersCtx) {
        if (charts.ordersChart) {
            charts.ordersChart.destroy();
        }
        
        const statusCounts = {
            pending: orders.filter(o => o.status === 'pending').length,
            preparing: orders.filter(o => o.status === 'preparing').length,
            ready: orders.filter(o => o.status === 'ready').length,
            completed: orders.filter(o => o.status === 'completed').length,
            cancelled: orders.filter(o => o.status === 'cancelled').length
        };
        
        charts.ordersChart = new Chart(ordersCtx, {
            type: 'doughnut',
            data: {
                labels: ['Pending', 'Preparing', 'Ready', 'Completed', 'Cancelled'],
                datasets: [{
                    data: [
                        statusCounts.pending,
                        statusCounts.preparing,
                        statusCounts.ready,
                        statusCounts.completed,
                        statusCounts.cancelled
                    ],
                    backgroundColor: [
                        '#ffc107',
                        '#ff9800',
                        '#4caf50',
                        '#2196f3',
                        '#dc3545'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }
}

// ==================== ORDERS MANAGEMENT ====================
function loadOrdersTab() {
    const container = document.getElementById('tab-content-container');
    
    container.innerHTML = `
        <div class="d-flex justify-between align-center mb-30">
            <h2 style="color: var(--white); font-size: 1.8rem;">Order Management</h2>
            <div class="d-flex gap-10">
                <button id="create-order-btn" class="btn"><i class="fas fa-plus"></i> New Order</button>
                <button id="refresh-orders-btn" class="btn btn-secondary">Refresh</button>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label>Date From</label>
                <input type="date" id="filter-date-from" class="form-control" value="${new Date().toISOString().split('T')[0]}">
            </div>
            <div class="filter-group">
                <label>Date To</label>
                <input type="date" id="filter-date-to" class="form-control" value="${new Date().toISOString().split('T')[0]}">
            </div>
            <div class="filter-group">
                <label>Status</label>
                <select id="filter-status" class="form-control">
                    <option value="all">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="preparing">Preparing</option>
                    <option value="ready">Ready</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Order Type</label>
                <select id="filter-type" class="form-control">
                    <option value="all">All Types</option>
                    <option value="walk-in">Walk-in</option>
                    <option value="just-eat">Just Eat</option>
                    <option value="deliveroo">Deliveroo</option>
                    <option value="uber-eats">Uber Eats</option>
                    <option value="phone">Phone</option>
                    <option value="online">Online</option>
                </select>
            </div>
            <div class="filter-group" style="align-self: flex-end;">
                <button id="apply-filters" class="btn">Apply Filters</button>
                <button id="clear-filters" class="btn btn-secondary">Clear</button>
            </div>
        </div>
        
        <div class="orders-grid" id="orders-container">
            <div class="card" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                <h3>Loading orders...</h3>
                <p>Please wait while we fetch your orders</p>
            </div>
        </div>
    `;
    
    // Add event listeners
    document.getElementById('create-order-btn')?.addEventListener('click', openOrderModal);
    document.getElementById('refresh-orders-btn')?.addEventListener('click', updateOrdersView);
    document.getElementById('apply-filters')?.addEventListener('click', updateOrdersView);
    document.getElementById('clear-filters')?.addEventListener('click', clearFilters);
    
    // Load orders
    updateOrdersView();
}

async function updateOrdersView() {
    const container = document.getElementById('orders-container');
    if (!container) return;
    
    // Get filter values
    const dateFrom = document.getElementById('filter-date-from')?.value;
    const dateTo = document.getElementById('filter-date-to')?.value;
    const statusFilter = document.getElementById('filter-status')?.value;
    const typeFilter = document.getElementById('filter-type')?.value;
    
    // Filter orders
    let filteredOrders = [...orders];
    
    if (dateFrom) {
        filteredOrders = filteredOrders.filter(order => 
            order.createdAt && order.createdAt.split('T')[0] >= dateFrom
        );
    }
    
    if (dateTo) {
        filteredOrders = filteredOrders.filter(order => 
            order.createdAt && order.createdAt.split('T')[0] <= dateTo
        );
    }
    
    if (statusFilter && statusFilter !== 'all') {
        filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
    }
    
    if (typeFilter && typeFilter !== 'all') {
        filteredOrders = filteredOrders.filter(order => order.type === typeFilter);
    }
    
    // Sort by date (newest first)
    filteredOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    // Display orders
    container.innerHTML = '';
    
    if (filteredOrders.length === 0) {
        container.innerHTML = `
            <div class="card" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                <h3>No orders found</h3>
                <p>Try adjusting your filters or create a new order</p>
            </div>
        `;
        return;
    }
    
    filteredOrders.forEach(order => {
        const orderCard = createOrderCard(order);
        container.appendChild(orderCard);
    });
}

function createOrderCard(order) {
    const card = document.createElement('div');
    card.className = `order-card ${order.status || 'pending'}`;
    
    const orderDate = new Date(order.createdAt);
    const timeString = orderDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const dateString = orderDate.toLocaleDateString('en-GB');
    
    let itemsHTML = '';
    if (order.items && order.items.length > 0) {
        order.items.forEach(item => {
            itemsHTML += `
                <div class="order-item">
                    <span>${item.quantity || 1}x ${item.name}</span>
                    <span>£${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</span>
                </div>
            `;
        });
    }
    
    card.innerHTML = `
        <div class="order-header">
            <div class="order-id">${order.orderNumber || order.id}</div>
            <div class="order-time">${dateString} ${timeString}</div>
        </div>
        <div class="order-items">
            ${itemsHTML || '<p style="color: var(--light-gray); text-align: center;">No items</p>'}
        </div>
        <div class="order-total">
            <span>Total</span>
            <span>£${(order.total || 0).toFixed(2)}</span>
        </div>
        <div class="d-flex justify-between mt-20">
            <div>
                <span class="status-badge status-${order.status || 'pending'}">${order.status || 'pending'}</span>
            </div>
            <div class="action-buttons">
                ${order.status === 'pending' ? `<button class="btn btn-small btn-success" onclick="updateOrderStatus('${order.id}', 'preparing')">Accept</button>` : ''}
                ${order.status === 'preparing' ? `<button class="btn btn-small btn-warning" onclick="updateOrderStatus('${order.id}', 'ready')">Mark Ready</button>` : ''}
                ${order.status === 'ready' ? `<button class="btn btn-small btn-success" onclick="updateOrderStatus('${order.id}', 'completed')">Complete</button>` : ''}
                ${order.status !== 'completed' && order.status !== 'cancelled' ? `<button class="btn btn-small btn-secondary" onclick="cancelOrder('${order.id}')">Cancel</button>` : ''}
            </div>
        </div>
        <div class="mt-10" style="font-size: 0.9rem; color: var(--light-gray);">
            <i class="fas fa-user"></i> ${order.customerName || 'N/A'} | 
            <i class="fas fa-${order.deliveryAddress ? 'truck' : 'shopping-bag'}"></i> ${order.deliveryAddress ? 'Delivery' : 'Takeaway'} |
            <i class="fas fa-credit-card"></i> ${order.paymentMethod || 'N/A'}
        </div>
        ${order.notes ? `<div class="mt-10" style="font-size: 0.9rem; color: var(--warning);"><i class="fas fa-sticky-note"></i> ${order.notes}</div>` : ''}
    `;
    
    return card;
}

function openOrderModal() {
    const modal = document.getElementById('order-modal');
    modal.style.display = 'flex';
    
    // Load menu items
    loadMenuItemsForOrder();
}

function loadMenuItemsForOrder() {
    const container = document.getElementById('menu-items-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (menuItems.length === 0) {
        container.innerHTML = '<p style="color: var(--light-gray); text-align: center;">No menu items available</p>';
        return;
    }
    
    // Group by category
    const categories = {};
    menuItems.forEach(item => {
        if (item.status !== 'active') return;
        
        if (!categories[item.category]) {
            categories[item.category] = [];
        }
        categories[item.category].push(item);
    });
    
    // Create buttons
    for (const category in categories) {
        const categoryHeader = document.createElement('div');
        categoryHeader.style.cssText = 'color: var(--primary-red); font-weight: bold; margin-top: 10px;';
        categoryHeader.textContent = category;
        container.appendChild(categoryHeader);
        
        categories[category].forEach(item => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'btn btn-small btn-secondary';
            button.style.margin = '5px';
            button.textContent = `${item.name} - £${item.price.toFixed(2)}`;
            button.onclick = () => addItemToOrder(item);
            container.appendChild(button);
        });
    }
    
    // Clear selected items
    selectedOrderItems = [];
    updateSelectedItemsDisplay();
}

function addItemToOrder(item) {
    const existingItem = selectedOrderItems.find(i => i.id === item.id);
    
    if (existingItem) {
        existingItem.quantity = (existingItem.quantity || 0) + 1;
    } else {
        selectedOrderItems.push({
            id: item.id,
            name: item.name,
            price: item.price,
            quantity: 1
        });
    }
    
    updateSelectedItemsDisplay();
    updateOrderTotal();
}

function updateSelectedItemsDisplay() {
    const container = document.getElementById('selected-items');
    if (!container) return;
    
    if (selectedOrderItems.length === 0) {
        container.innerHTML = '<p style="color: var(--light-gray); text-align: center;">No items selected</p>';
        return;
    }
    
    let html = '<div style="display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid var(--gray); font-weight: bold;">';
    html += '<span>Item</span><span>Qty</span><span>Price</span><span>Action</span></div>';
    
    selectedOrderItems.forEach((item, index) => {
        html += `
            <div style="display: flex; justify-content: space-between; padding: 8px 5px; border-bottom: 1px dashed var(--gray); align-items: center;">
                <span>${item.name}</span>
                <span>
                    <button class="btn btn-small" onclick="adjustOrderQuantity(${index}, -1)" style="padding: 2px 8px;">-</button>
                    ${item.quantity || 0}
                    <button class="btn btn-small" onclick="adjustOrderQuantity(${index}, 1)" style="padding: 2px 8px;">+</button>
                </span>
                <span>£${((item.price || 0) * (item.quantity || 0)).toFixed(2)}</span>
                <button class="btn btn-small" onclick="removeOrderItem(${index})" style="background-color: var(--primary-red); padding: 2px 8px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updateOrderTotal() {
    const total = selectedOrderItems.reduce((sum, item) => 
        sum + ((item.price || 0) * (item.quantity || 0)), 0);
    document.getElementById('order-total').value = `£${total.toFixed(2)}`;
}

async function submitOrder() {
    const customerName = document.getElementById('customer-name').value.trim();
    const orderType = document.getElementById('order-type').value;
    const paymentMethod = document.getElementById('payment-method').value;
    const notes = document.getElementById('order-notes').value;
    const deliveryAddress = document.getElementById('delivery-address').value;
    const phone = document.getElementById('customer-phone').value;
    
    if (!customerName) {
        showToast('Please enter customer name', 'error');
        return;
    }
    
    if (selectedOrderItems.length === 0) {
        showToast('Please add items to the order', 'error');
        return;
    }
    
    // Calculate total
    const total = selectedOrderItems.reduce((sum, item) => 
        sum + ((item.price || 0) * (item.quantity || 0)), 0);
    
    // Generate order number
    const orderNumber = generateOrderNumber();
    
    // Create order object
    const order = {
        id: generateId(),
        orderNumber: orderNumber,
        customerName: customerName,
        customerPhone: phone,
        type: orderType,
        deliveryAddress: deliveryAddress,
        items: selectedOrderItems.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            quantity: item.quantity || 1
        })),
        total: total,
        paymentMethod: paymentMethod,
        notes: notes,
        status: 'pending',
        createdAt: new Date().toISOString(),
        createdBy: currentUser.uid
    };
    
    try {
        // Save to Firestore
        await firebaseFirestore.collection('orders').doc(order.id).set(order);
        
        // Add to local array
        orders.unshift(order);
        
        // Close modal and reset form
        document.getElementById('order-modal').style.display = 'none';
        document.getElementById('customer-name').value = '';
        document.getElementById('customer-phone').value = '';
        document.getElementById('delivery-address').value = '';
        document.getElementById('order-notes').value = '';
        selectedOrderItems = [];
        updateSelectedItemsDisplay();
        updateOrderTotal();
        
        showToast(`Order ${orderNumber} created successfully!`, 'success');
        
        // Update views
        updateOrdersView();
        updateDashboard();
        
    } catch (error) {
        console.error('Error saving order:', error);
        showToast('Error creating order', 'error');
    }
}

async function updateOrderStatus(orderId, newStatus) {
    try {
        const order = orders.find(o => o.id === orderId);
        if (!order) {
            showToast('Order not found', 'error');
            return;
        }
        
        // Update in Firestore
        await firebaseFirestore.collection('orders').doc(orderId).update({
            status: newStatus,
            updatedAt: new Date().toISOString()
        });
        
        // Update local array
        order.status = newStatus;
        order.updatedAt = new Date().toISOString();
        
        showToast(`Order ${order.orderNumber} status updated to ${newStatus}`, 'success');
        
        // Update views
        updateOrdersView();
        updateDashboard();
        
        // Play sound for kitchen updates
        if (soundEnabled && (newStatus === 'preparing' || newStatus === 'ready')) {
            playNotificationSound();
        }
        
    } catch (error) {
        console.error('Error updating order status:', error);
        showToast('Error updating order status', 'error');
    }
}

async function cancelOrder(orderId) {
    if (!confirm('Are you sure you want to cancel this order?')) {
        return;
    }
    
    await updateOrderStatus(orderId, 'cancelled');
}

// ==================== KITCHEN VIEW ====================
function loadKitchenTab() {
    const container = document.getElementById('tab-content-container');
    
    container.innerHTML = `
        <div class="d-flex justify-between align-center mb-30">
            <h2 style="color: var(--white); font-size: 1.8rem;">Kitchen Management</h2>
            <div class="d-flex gap-10">
                <button id="refresh-kitchen-btn" class="btn">Refresh</button>
                <button id="kitchen-settings-btn" class="btn btn-secondary">Settings</button>
            </div>
        </div>
        
        <div class="dashboard-cards mb-30">
            <div class="card">
                <h3>Orders Preparing</h3>
                <div class="value" id="preparing-count">0</div>
                <div class="trend">In Progress</div>
            </div>
            
            <div class="card">
                <h3>Orders Ready</h3>
                <div class="value" id="ready-count">0</div>
                <div class="trend">Waiting for pickup</div>
            </div>
            
            <div class="card">
                <h3>Urgent Orders</h3>
                <div class="value" id="urgent-count">0</div>
                <div class="trend">Need attention</div>
            </div>
            
            <div class="card">
                <h3>Avg Cook Time</h3>
                <div class="value" id="avg-cook-time">0m</div>
                <div class="trend">Current shift</div>
            </div>
        </div>
        
        <div class="kitchen-orders-grid" id="kitchen-orders-container">
            <div class="card" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                <h3>Loading kitchen orders...</h3>
                <p>Please wait while we fetch kitchen orders</p>
            </div>
        </div>
    `;
    
    // Add event listeners
    document.getElementById('refresh-kitchen-btn')?.addEventListener('click', updateKitchenView);
    
    // Load kitchen view
    updateKitchenView();
    
    // Start auto-refresh for kitchen
    startKitchenAutoRefresh();
}

function updateKitchenView() {
    // Update stats
    const preparingOrders = orders.filter(o => o.status === 'preparing');
    const readyOrders = orders.filter(o => o.status === 'ready');
    
    document.getElementById('preparing-count').textContent = preparingOrders.length;
    document.getElementById('ready-count').textContent = readyOrders.length;
    
    // Calculate urgent orders (pending for more than 5 minutes)
    const urgentOrders = orders.filter(order => {
        if (order.status !== 'pending') return false;
        
        const orderTime = new Date(order.createdAt);
        const now = new Date();
        const minutes = (now - orderTime) / (1000 * 60);
        return minutes > 5;
    });
    
    document.getElementById('urgent-count').textContent = urgentOrders.length;
    
    // Calculate average cook time for completed orders today
    const today = new Date().toISOString().split('T')[0];
    const todayCompleted = orders.filter(o => 
        o.status === 'completed' && 
        o.completedAt?.split('T')[0] === today
    );
    
    const avgTime = todayCompleted.length > 0 ? 
        todayCompleted.reduce((sum, o) => sum + (o.cookTime || 10), 0) / todayCompleted.length : 0;
    document.getElementById('avg-cook-time').textContent = `${avgTime.toFixed(0)}m`;
    
    // Update kitchen orders grid
    updateKitchenOrdersGrid();
}

function updateKitchenOrdersGrid() {
    const container = document.getElementById('kitchen-orders-container');
    if (!container) return;
    
    // Get orders that need kitchen attention
    const kitchenOrders = orders.filter(o => 
        o.status === 'pending' || o.status === 'preparing' || o.status === 'ready'
    );
    
    // Sort by priority (urgent first, then by status)
    kitchenOrders.sort((a, b) => {
        // Check if order is urgent
        const aTime = new Date(a.createdAt);
        const bTime = new Date(b.createdAt);
        const now = new Date();
        
        const aMinutes = (now - aTime) / (1000 * 60);
        const bMinutes = (now - bTime) / (1000 * 60);
        
        const aUrgent = a.status === 'pending' && aMinutes > 5;
        const bUrgent = b.status === 'pending' && bMinutes > 5;
        
        if (aUrgent && !bUrgent) return -1;
        if (!aUrgent && bUrgent) return 1;
        
        // Then by status priority
        const statusPriority = { 'pending': 0, 'preparing': 1, 'ready': 2 };
        return statusPriority[a.status] - statusPriority[b.status];
    });
    
    container.innerHTML = '';
    
    if (kitchenOrders.length === 0) {
        container.innerHTML = `
            <div class="card" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                <h3>All caught up!</h3>
                <p>No orders in the kitchen</p>
            </div>
        `;
        return;
    }
    
    kitchenOrders.forEach(order => {
        const orderCard = createKitchenOrderCard(order);
        container.appendChild(orderCard);
    });
}

function createKitchenOrderCard(order) {
    const card = document.createElement('div');
    const isUrgent = isOrderUrgent(order);
    
    card.className = `kitchen-order-card ${order.status} ${isUrgent ? 'urgent' : ''}`;
    
    const orderTime = new Date(order.createdAt);
    const elapsedMinutes = Math.floor((new Date() - orderTime) / (1000 * 60));
    
    let itemsHTML = '';
    if (order.items && order.items.length > 0) {
        order.items.forEach(item => {
            itemsHTML += `
                <div class="order-item">
                    <span>${item.quantity || 1}x ${item.name}</span>
                    <span>${item.cookTime || 'N/A'}m</span>
                </div>
            `;
        });
    }
    
    // Calculate timer display
    let timerDisplay = '';
    if (order.status === 'preparing') {
        const startTime = order.startedAt ? new Date(order.startedAt) : orderTime;
        const elapsed = Math.floor((new Date() - startTime) / (1000 * 60));
        const estimatedTime = order.items ? 
            Math.max(...order.items.map(i => i.cookTime || 10)) : 10;
        
        const timeLeft = Math.max(0, estimatedTime - elapsed);
        let timerClass = '';
        
        if (timeLeft <= 2) {
            timerClass = 'danger';
        } else if (timeLeft <= 5) {
            timerClass = 'warning';
        }
        
        timerDisplay = `<div class="timer-display ${timerClass}">${timeLeft}m</div>`;
    }
    
    card.innerHTML = `
        <div class="order-header">
            <div class="order-id">${order.orderNumber}</div>
            <div class="order-time">${elapsedMinutes}m ago</div>
        </div>
        ${timerDisplay}
        <div class="order-items">
            ${itemsHTML || '<p style="color: var(--light-gray); text-align: center;">No items</p>'}
        </div>
        <div class="mt-20">
            <div style="color: var(--light-gray); font-size: 0.9rem;">
                <i class="fas fa-${order.deliveryAddress ? 'truck' : 'shopping-bag'}"></i> ${order.deliveryAddress ? 'Delivery' : 'Takeaway'} |
                <i class="fas fa-user"></i> ${order.customerName}
            </div>
            ${order.notes ? `<div class="mt-10" style="color: var(--warning); font-size: 0.9rem;"><i class="fas fa-sticky-note"></i> ${order.notes}</div>` : ''}
        </div>
        <div class="action-buttons mt-20">
            ${order.status === 'pending' ? `
                <button class="btn btn-small btn-success" onclick="startPreparingOrder('${order.id}')">Start Preparing</button>
            ` : ''}
            ${order.status === 'preparing' ? `
                <button class="btn btn-small btn-warning" onclick="markOrderReady('${order.id}')">Mark Ready</button>
                <button class="btn btn-small btn-secondary" onclick="addCookTime('${order.id}', 5)">+5 min</button>
            ` : ''}
            ${order.status === 'ready' ? `
                <button class="btn btn-small btn-success" onclick="completeOrder('${order.id}')">Complete</button>
            ` : ''}
        </div>
    `;
    
    return card;
}

function isOrderUrgent(order) {
    if (order.status !== 'pending') return false;
    
    const orderTime = new Date(order.createdAt);
    const now = new Date();
    const minutes = (now - orderTime) / (1000 * 60);
    return minutes > 5;
}

async function startPreparingOrder(orderId) {
    await updateOrderStatus(orderId, 'preparing');
    // Set start time
    await firebaseFirestore.collection('orders').doc(orderId).update({
        startedAt: new Date().toISOString()
    });
}

async function markOrderReady(orderId) {
    await updateOrderStatus(orderId, 'ready');
}

async function completeOrder(orderId) {
    await updateOrderStatus(orderId, 'completed');
    // Set completion time
    await firebaseFirestore.collection('orders').doc(orderId).update({
        completedAt: new Date().toISOString()
    });
}

async function addCookTime(orderId, minutes) {
    // This would update the estimated cook time in a real system
    showToast(`Added ${minutes} minutes to cook time`, 'info');
}

// ==================== STAFF MANAGEMENT ====================
function loadStaffTab() {
    const container = document.getElementById('tab-content-container');
    
    container.innerHTML = `
        <div class="d-flex justify-between align-center mb-30">
            <h2 style="color: var(--white); font-size: 1.8rem;">Staff Management</h2>
            <div class="d-flex gap-10">
                <button id="add-staff-btn" class="btn"><i class="fas fa-plus"></i> Add Staff</button>
                <button id="refresh-staff-btn" class="btn btn-secondary">Refresh</button>
            </div>
        </div>
        
        <div class="table-container">
            <table id="staff-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Hourly Rate</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="staff-table-body">
                    <tr><td colspan="7" style="text-align: center; padding: 30px;">Loading staff...</td></tr>
                </tbody>
            </table>
        </div>
    `;
    
    // Add event listeners
    document.getElementById('add-staff-btn')?.addEventListener('click', openStaffModal);
    document.getElementById('refresh-staff-btn')?.addEventListener('click', updateStaffTable);
    
    // Load staff table
    updateStaffTable();
}

function updateStaffTable() {
    const tbody = document.getElementById('staff-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (staff.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">No staff members found</td></tr>';
        return;
    }
    
    staff.forEach(member => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${member.name}</td>
            <td><span class="role-${member.role}">${member.role}</span></td>
            <td>${member.email}</td>
            <td>${member.phone || 'N/A'}</td>
            <td>£${member.hourlyRate?.toFixed(2) || '0.00'}</td>
            <td><span class="status-badge ${member.active ? 'status-completed' : 'status-cancelled'}">${member.active ? 'Active' : 'Inactive'}</span></td>
            <td>
                <button class="btn btn-small btn-info" onclick="editStaff('${member.id}')">Edit</button>
                <button class="btn btn-small ${member.active ? 'btn-warning' : 'btn-success'}" onclick="toggleStaffStatus('${member.id}')">
                    ${member.active ? 'Deactivate' : 'Activate'}
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function openStaffModal() {
    const modal = document.getElementById('staff-modal');
    modal.style.display = 'flex';
    
    // Clear form
    document.getElementById('staff-name').value = '';
    document.getElementById('staff-email').value = '';
    document.getElementById('staff-phone').value = '';
    document.getElementById('staff-rate').value = '10.50';
    document.getElementById('staff-password').value = '';
    document.getElementById('staff-role').value = 'server';
}

async function saveStaff() {
    const name = document.getElementById('staff-name').value.trim();
    const email = document.getElementById('staff-email').value.trim();
    const phone = document.getElementById('staff-phone').value.trim();
    const rate = parseFloat(document.getElementById('staff-rate').value);
    const password = document.getElementById('staff-password').value;
    const role = document.getElementById('staff-role').value;
    
    if (!name || !email || !password) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    
    if (password.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
    }
    
    try {
        // Create user in Firebase Auth
        const userCredential = await firebaseAuth.createUserWithEmailAndPassword(email, password);
        const userId = userCredential.user.uid;
        
        // Create staff record
        const staffData = {
            id: userId,
            name: name,
            email: email,
            phone: phone,
            role: role,
            hourlyRate: rate,
            active: true,
            createdAt: new Date().toISOString(),
            createdBy: currentUser.uid
        };
        
        // Save to Firestore
        await firebaseFirestore.collection('staff').doc(userId).set(staffData);
        
        // Also create user document
        await firebaseFirestore.collection('users').doc(userId).set({
            email: email,
            role: role,
            name: name,
            createdAt: new Date().toISOString()
        });
        
        // Close modal
        document.getElementById('staff-modal').style.display = 'none';
        
        showToast(`Staff member ${name} added successfully`, 'success');
        
        // Sign out the new user (they'll log in themselves)
        await firebaseAuth.signOut();
        await firebaseAuth.signInWithEmailAndPassword(currentUser.email, localStorage.getItem('currentPassword') || '');
        
    } catch (error) {
        console.error('Error saving staff:', error);
        
        if (error.code === 'auth/email-already-in-use') {
            showToast('Email already registered', 'error');
        } else {
            showToast('Error saving staff member', 'error');
        }
    }
}

// ==================== ATTENDANCE ====================
function loadAttendanceTab() {
    const container = document.getElementById('tab-content-container');
    
    container.innerHTML = `
        <div class="d-flex justify-between align-center mb-30">
            <h2 style="color: var(--white); font-size: 1.8rem;">Attendance Management</h2>
            <div class="d-flex gap-10">
                <button id="mark-attendance-btn" class="btn"><i class="fas fa-plus"></i> Mark Attendance</button>
                <button id="refresh-attendance-btn" class="btn btn-secondary">Refresh</button>
            </div>
        </div>
        
        <div class="attendance-container">
            <h3 style="color: var(--white); margin-bottom: 20px;">Today's Attendance</h3>
            <div class="d-flex justify-between align-center">
                <div>
                    <div style="color: var(--light-gray);">Date: <span id="current-attendance-date" style="color: var(--white); font-weight: bold;">${new Date().toLocaleDateString('en-GB')}</span></div>
                    <div style="color: var(--light-gray); margin-top: 5px;">Shift: <span id="current-shift" style="color: var(--white);">Morning (9:00 - 17:00)</span></div>
                </div>
                <div class="d-flex gap-10">
                    <button id="start-shift-btn" class="btn btn-success">Start Shift</button>
                    <button id="end-shift-btn" class="btn" style="background-color: var(--primary-red);">End Shift</button>
                </div>
            </div>
            
            <div class="attendance-grid mt-30" id="attendance-grid">
                <!-- Attendance cards will be loaded here -->
            </div>
            
            <div class="report-cards mt-30">
                <div class="report-card">
                    <h4>Present Today</h4>
                    <div class="report-value" id="present-count">0</div>
                    <div class="report-details">Staff members present</div>
                </div>
                <div class="report-card">
                    <h4>Absent Today</h4>
                    <div class="report-value" id="absent-count">0</div>
                    <div class="report-details">Staff members absent</div>
                </div>
                <div class="report-card">
                    <h4>Late Arrivals</h4>
                    <div class="report-value" id="late-count">0</div>
                    <div class="report-details">Late arrivals today</div>
                </div>
            </div>
        </div>
    `;
    
    // Add event listeners
    document.getElementById('mark-attendance-btn')?.addEventListener('click', openAttendanceModal);
    document.getElementById('refresh-attendance-btn')?.addEventListener('click', updateAttendanceView);
    document.getElementById('start-shift-btn')?.addEventListener('click', startShift);
    document.getElementById('end-shift-btn')?.addEventListener('click', endShift);
    
    // Load attendance
    updateAttendanceView();
}

function updateAttendanceView() {
    const today = new Date().toISOString().split('T')[0];
    const todayAttendance = attendance.filter(record => record.date === today);
    
    const container = document.getElementById('attendance-grid');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (todayAttendance.length === 0) {
        container.innerHTML = '<p style="color: var(--light-gray); text-align: center; width: 100%;">No attendance records for today</p>';
        return;
    }
    
    let presentCount = 0, absentCount = 0, lateCount = 0;
    
    todayAttendance.forEach(record => {
        const staffMember = staff.find(s => s.id === record.staffId);
        if (!staffMember) return;
        
        if (record.status === 'present') presentCount++;
        if (record.status === 'absent') absentCount++;
        if (record.status === 'late') lateCount++;
        
        const card = document.createElement('div');
        card.className = 'attendance-card';
        card.innerHTML = `
            <h4 style="color: var(--white); margin-bottom: 5px;">${staffMember.name}</h4>
            <div style="color: var(--light-gray); font-size: 0.9rem;">
                <div>Role: ${staffMember.role}</div>
                <div>Clock In: ${record.clockIn || '--:--'}</div>
                <div>Clock Out: ${record.clockOut || '--:--'}</div>
                <div>Hours: ${record.hours || 0}</div>
            </div>
            <span class="attendance-status status-${record.status}">${record.status.toUpperCase()}</span>
            <div class="attendance-actions">
                <button class="btn btn-small btn-success" onclick="updateAttendance('${record.id}', 'present')">Present</button>
                <button class="btn btn-small" style="background-color: var(--primary-red);" onclick="updateAttendance('${record.id}', 'absent')">Absent</button>
                <button class="btn btn-small btn-warning" onclick="updateAttendance('${record.id}', 'late')">Late</button>
            </div>
        `;
        container.appendChild(card);
    });
    
    // Update counts
    document.getElementById('present-count').textContent = presentCount;
    document.getElementById('absent-count').textContent = absentCount;
    document.getElementById('late-count').textContent = lateCount;
}

function openAttendanceModal() {
    const modal = document.getElementById('attendance-modal');
    modal.style.display = 'flex';
    
    // Load staff
    const select = document.getElementById('attendance-staff');
    select.innerHTML = '<option value="">Select Staff</option>';
    
    staff.forEach(member => {
        const option = document.createElement('option');
        option.value = member.id;
        option.textContent = member.name;
        select.appendChild(option);
    });
}

async function saveAttendance() {
    const staffId = document.getElementById('attendance-staff').value;
    const date = document.getElementById('attendance-date').value;
    const status = document.getElementById('attendance-status').value;
    const clockIn = document.getElementById('clock-in-time').value;
    const clockOut = document.getElementById('clock-out-time').value;
    const notes = document.getElementById('attendance-notes').value;
    
    if (!staffId || !date) {
        showToast('Please select staff and date', 'error');
        return;
    }
    
    const staffMember = staff.find(s => s.id === staffId);
    if (!staffMember) {
        showToast('Staff member not found', 'error');
        return;
    }
    
    // Calculate hours
    let hours = 0;
    if (clockIn && clockOut) {
        const [inHour, inMinute] = clockIn.split(':').map(Number);
        const [outHour, outMinute] = clockOut.split(':').map(Number);
        hours = outHour - inHour + (outMinute - inMinute) / 60;
    }
    
    try {
        const attendanceData = {
            id: generateId(),
            staffId: staffId,
            staffName: staffMember.name,
            date: date,
            status: status,
            clockIn: clockIn,
            clockOut: clockOut,
            hours: hours,
            notes: notes,
            recordedAt: new Date().toISOString(),
            recordedBy: currentUser.uid
        };
        
        // Save to Firestore
        await firebaseFirestore.collection('attendance').doc(attendanceData.id).set(attendanceData);
        
        // Close modal
        document.getElementById('attendance-modal').style.display = 'none';
        
        showToast('Attendance recorded successfully', 'success');
        
    } catch (error) {
        console.error('Error saving attendance:', error);
        showToast('Error saving attendance', 'error');
    }
}

// ==================== PAYROLL ====================
function loadPayrollTab() {
    const container = document.getElementById('tab-content-container');
    
    container.innerHTML = `
        <div class="d-flex justify-between align-center mb-30">
            <h2 style="color: var(--white); font-size: 1.8rem;">Payroll Management</h2>
            <div class="d-flex gap-10">
                <button id="process-payroll-btn" class="btn"><i class="fas fa-calculator"></i> Process Payroll</button>
                <button id="refresh-payroll-btn" class="btn btn-secondary">Refresh</button>
            </div>
        </div>
        
        <div class="payroll-container">
            <div class="d-flex gap-20 mb-30">
                <div class="filter-group" style="flex: 1;">
                    <label>Pay Period</label>
                    <select id="payroll-period-filter" class="form-control">
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <div class="filter-group" style="flex: 1;">
                    <label>Start Date</label>
                    <input type="date" id="payroll-start-filter" class="form-control" value="${getDateString(-7)}">
                </div>
                <div class="filter-group" style="flex: 1;">
                    <label>End Date</label>
                    <input type="date" id="payroll-end-filter" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="filter-group" style="align-self: flex-end;">
                    <button id="calculate-payroll-filter" class="btn">Calculate</button>
                </div>
            </div>
            
            <div class="payroll-summary">
                <div class="payroll-item">
                    <h4>Total Staff</h4>
                    <div class="report-value" id="payroll-staff-count">0</div>
                </div>
                <div class="payroll-item">
                    <h4>Total Hours</h4>
                    <div class="report-value" id="payroll-total-hours">0</div>
                </div>
                <div class="payroll-item">
                    <h4>Total Salary</h4>
                    <div class="report-value" id="payroll-total-salary">£0.00</div>
                </div>
                <div class="payroll-item">
                    <h4>Total Tax</h4>
                    <div class="report-value" id="payroll-total-tax">£0.00</div>
                </div>
            </div>
            
            <div class="table-container mt-30">
                <table id="payroll-details-table">
                    <thead>
                        <tr>
                            <th>Staff Name</th>
                            <th>Role</th>
                            <th>Hours</th>
                            <th>Rate</th>
                            <th>Basic Pay</th>
                            <th>Overtime</th>
                            <th>Deductions</th>
                            <th>Net Pay</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="payroll-details-body">
                        <tr><td colspan="9" style="text-align: center; padding: 30px;">Calculate payroll to view details</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    // Add event listeners
    document.getElementById('process-payroll-btn')?.addEventListener('click', openPayrollModal);
    document.getElementById('refresh-payroll-btn')?.addEventListener('click', calculatePayroll);
    document.getElementById('calculate-payroll-filter')?.addEventListener('click', calculatePayroll);
    
    // Initial calculation
    calculatePayroll();
}

async function calculatePayroll() {
    const startDate = document.getElementById('payroll-start-filter')?.value;
    const endDate = document.getElementById('payroll-end-filter')?.value;
    
    if (!startDate || !endDate) {
        showToast('Please select date range', 'error');
        return;
    }
    
    try {
        // Get attendance for period
        const attendanceSnapshot = await firebaseFirestore.collection('attendance')
            .where('date', '>=', startDate)
            .where('date', '<=', endDate)
            .get();
        
        const attendanceData = attendanceSnapshot.docs.map(doc => doc.data());
        
        // Calculate payroll for each staff member
        const payrollData = [];
        let totalHours = 0;
        let totalSalary = 0;
        let totalTax = 0;
        
        for (const member of staff) {
            if (!member.active) continue;
            
            // Get attendance for this staff member
            const memberAttendance = attendanceData.filter(a => a.staffId === member.id);
            const totalMemberHours = memberAttendance.reduce((sum, a) => sum + (a.hours || 0), 0);
            
            // Calculate pay
            const hourlyRate = member.hourlyRate || 10.50;
            const basicHours = Math.min(totalMemberHours, 40);
            const overtimeHours = Math.max(0, totalMemberHours - 40);
            
            const basicPay = basicHours * hourlyRate;
            const overtimePay = overtimeHours * hourlyRate * 1.5;
            const totalPay = basicPay + overtimePay;
            const tax = totalPay * 0.2; // 20% tax
            const netPay = totalPay - tax;
            
            payrollData.push({
                staffId: member.id,
                name: member.name,
                role: member.role,
                hours: totalMemberHours,
                rate: hourlyRate,
                basicPay: basicPay,
                overtimePay: overtimePay,
                tax: tax,
                netPay: netPay,
                status: 'pending'
            });
            
            totalHours += totalMemberHours;
            totalSalary += netPay;
            totalTax += tax;
        }
        
        // Update summary
        document.getElementById('payroll-staff-count').textContent = payrollData.length;
        document.getElementById('payroll-total-hours').textContent = totalHours.toFixed(1);
        document.getElementById('payroll-total-salary').textContent = `£${totalSalary.toFixed(2)}`;
        document.getElementById('payroll-total-tax').textContent = `£${totalTax.toFixed(2)}`;
        
        // Update table
        const tbody = document.getElementById('payroll-details-body');
        tbody.innerHTML = '';
        
        payrollData.forEach(data => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${data.name}</td>
                <td>${data.role}</td>
                <td>${data.hours.toFixed(1)}</td>
                <td>£${data.rate.toFixed(2)}</td>
                <td>£${data.basicPay.toFixed(2)}</td>
                <td>£${data.overtimePay.toFixed(2)}</td>
                <td>£${data.tax.toFixed(2)}</td>
                <td>£${data.netPay.toFixed(2)}</td>
                <td><span class="status-badge status-pending">Pending</span></td>
            `;
            tbody.appendChild(row);
        });
        
    } catch (error) {
        console.error('Error calculating payroll:', error);
        showToast('Error calculating payroll', 'error');
    }
}

// ==================== REPORTS ====================
function loadReportsTab() {
    const container = document.getElementById('tab-content-container');
    
    container.innerHTML = `
        <div class="d-flex justify-between align-center mb-30">
            <h2 style="color: var(--white); font-size: 1.8rem;">Business Reports</h2>
            <div class="d-flex gap-10">
                <button id="export-report-btn" class="btn btn-success">Export to Excel</button>
                <button id="print-report-btn" class="btn btn-secondary">Print Report</button>
            </div>
        </div>
        
        <div class="report-filters">
            <div class="filter-group">
                <label>Report Type</label>
                <select id="report-type" class="form-control">
                    <option value="sales">Sales Report</option>
                    <option value="staff">Staff Performance</option>
                    <option value="inventory">Inventory Report</option>
                    <option value="attendance">Attendance Report</option>
                    <option value="payroll">Payroll Report</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Date From</label>
                <input type="date" id="report-date-from" class="form-control" value="${getDateString(-30)}">
            </div>
            <div class="filter-group">
                <label>Date To</label>
                <input type="date" id="report-date-to" class="form-control" value="${new Date().toISOString().split('T')[0]}">
            </div>
            <div class="filter-group" style="align-self: flex-end;">
                <button id="generate-report-btn" class="btn">Generate Report</button>
            </div>
        </div>
        
        <div class="report-results" id="report-results">
            <div class="table-container">
                <div id="sales-report" style="display: block;">
                    <h3 style="color: var(--white); margin-bottom: 20px;">Sales Report</h3>
                    <table id="sales-report-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Orders</th>
                                <th>Revenue</th>
                                <th>Avg Order</th>
                                <th>Top Item</th>
                            </tr>
                        </thead>
                        <tbody id="sales-report-body">
                            <tr><td colspan="5" style="text-align: center; padding: 30px;">Generate report to view data</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="staff-report" style="display: none;">
                    <h3 style="color: var(--white); margin-bottom: 20px;">Staff Performance Report</h3>
                    <table id="staff-report-table">
                        <thead>
                            <tr>
                                <th>Staff Name</th>
                                <th>Role</th>
                                <th>Hours Worked</th>
                                <th>Orders Handled</th>
                                <th>Efficiency</th>
                            </tr>
                        </thead>
                        <tbody id="staff-report-body">
                            <tr><td colspan="5" style="text-align: center; padding: 30px;">Generate report to view data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="report-cards mt-30">
                <div class="report-card">
                    <h4>Total Revenue</h4>
                    <div class="report-value" id="report-total-revenue">£0.00</div>
                    <div class="report-details" id="report-revenue-period">For selected period</div>
                </div>
                <div class="report-card">
                    <h4>Total Orders</h4>
                    <div class="report-value" id="report-total-orders">0</div>
                    <div class="report-details" id="report-orders-period">For selected period</div>
                </div>
                <div class="report-card">
                    <h4>Average Order Value</h4>
                    <div class="report-value" id="report-avg-order">£0.00</div>
                    <div class="report-details" id="report-avg-period">For selected period</div>
                </div>
            </div>
        </div>
    `;
    
    // Add event listeners
    document.getElementById('generate-report-btn')?.addEventListener('click', generateReport);
    document.getElementById('export-report-btn')?.addEventListener('click', exportReport);
    document.getElementById('print-report-btn')?.addEventListener('click', printReport);
    
    // Generate initial report
    generateReport();
}

async function generateReport() {
    const reportType = document.getElementById('report-type').value;
    const dateFrom = document.getElementById('report-date-from').value;
    const dateTo = document.getElementById('report-date-to').value;
    
    // Hide all reports
    document.getElementById('sales-report').style.display = 'none';
    document.getElementById('staff-report').style.display = 'none';
    
    switch(reportType) {
        case 'sales':
            await generateSalesReport(dateFrom, dateTo);
            document.getElementById('sales-report').style.display = 'block';
            break;
        case 'staff':
            await generateStaffReport(dateFrom, dateTo);
            document.getElementById('staff-report').style.display = 'block';
            break;
        default:
            await generateSalesReport(dateFrom, dateTo);
            document.getElementById('sales-report').style.display = 'block';
    }
}

async function generateSalesReport(dateFrom, dateTo) {
    // Filter orders by date
    const filteredOrders = orders.filter(order => {
        const orderDate = order.createdAt?.split('T')[0];
        return orderDate && orderDate >= dateFrom && orderDate <= dateTo;
    });
    
    // Group by date
    const ordersByDate = {};
    filteredOrders.forEach(order => {
        const date = order.createdAt?.split('T')[0];
        if (!date) return;
        
        if (!ordersByDate[date]) {
            ordersByDate[date] = {
                orders: [],
                revenue: 0
            };
        }
        
        ordersByDate[date].orders.push(order);
        ordersByDate[date].revenue += order.total || 0;
    });
    
    // Update table
    const tbody = document.getElementById('sales-report-body');
    tbody.innerHTML = '';
    
    let totalRevenue = 0;
    let totalOrders = 0;
    
    Object.keys(ordersByDate).sort().forEach(date => {
        const data = ordersByDate[date];
        totalRevenue += data.revenue;
        totalOrders += data.orders.length;
        
        // Find top item for this day
        const itemCount = {};
        data.orders.forEach(order => {
            order.items?.forEach(item => {
                const itemName = item.name;
                itemCount[itemName] = (itemCount[itemName] || 0) + (item.quantity || 1);
            });
        });
        
        const topItem = Object.keys(itemCount).reduce((a, b) => 
            itemCount[a] > itemCount[b] ? a : Object.keys(itemCount)[0], 'None');
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date(date).toLocaleDateString('en-GB')}</td>
            <td>${data.orders.length}</td>
            <td>£${data.revenue.toFixed(2)}</td>
            <td>£${(data.revenue / data.orders.length || 0).toFixed(2)}</td>
            <td>${topItem}</td>
        `;
        tbody.appendChild(row);
    });
    
    // Update summary
    document.getElementById('report-total-revenue').textContent = `£${totalRevenue.toFixed(2)}`;
    document.getElementById('report-total-orders').textContent = totalOrders;
    document.getElementById('report-avg-order').textContent = `£${(totalRevenue / totalOrders || 0).toFixed(2)}`;
    document.getElementById('report-revenue-period').textContent = `${dateFrom} to ${dateTo}`;
}

// ==================== MENU MANAGEMENT ====================
function loadMenuTab() {
    const container = document.getElementById('tab-content-container');
    
    container.innerHTML = `
        <div class="d-flex justify-between align-center mb-30">
            <h2 style="color: var(--white); font-size: 1.8rem;">Menu Management</h2>
            <div class="d-flex gap-10">
                <button id="add-menu-item-btn" class="btn"><i class="fas fa-plus"></i> Add Item</button>
                <button id="refresh-menu-btn" class="btn btn-secondary">Refresh</button>
            </div>
        </div>
        
        <div class="table-container">
            <table id="menu-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Cost</th>
                        <th>Cook Time</th>
                        <th>Profit</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="menu-table-body">
                    <tr><td colspan="8" style="text-align: center; padding: 30px;">Loading menu items...</td></tr>
                </tbody>
            </table>
        </div>
    `;
    
    // Add event listeners
    document.getElementById('add-menu-item-btn')?.addEventListener('click', openMenuModal);
    document.getElementById('refresh-menu-btn')?.addEventListener('click', updateMenuTable);
    
    // Load menu table
    updateMenuTable();
}

function updateMenuTable() {
    const tbody = document.getElementById('menu-table-body');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (menuItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px;">No menu items found</td></tr>';
        return;
    }
    
    menuItems.forEach(item => {
        const profit = item.price - item.cost;
        const profitMargin = (profit / item.price) * 100;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.category}</td>
            <td>£${item.price.toFixed(2)}</td>
            <td>£${item.cost.toFixed(2)}</td>
            <td>${item.cookTime}m</td>
            <td>£${profit.toFixed(2)} (${profitMargin.toFixed(0)}%)</td>
            <td><span class="status-badge ${item.status === 'active' ? 'status-completed' : 'status-cancelled'}">${item.status}</span></td>
            <td>
                <button class="btn btn-small btn-info" onclick="editMenuItem('${item.id}')">Edit</button>
                <button class="btn btn-small ${item.status === 'active' ? 'btn-warning' : 'btn-success'}" onclick="toggleMenuItemStatus('${item.id}')">
                    ${item.status === 'active' ? 'Disable' : 'Enable'}
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function openMenuModal() {
    const modal = document.getElementById('menu-modal');
    modal.style.display = 'flex';
    
    // Clear form
    document.getElementById('menu-item-name').value = '';
    document.getElementById('menu-item-price').value = '';
    document.getElementById('menu-item-cost').value = '';
    document.getElementById('menu-item-cooktime').value = '10';
    document.getElementById('menu-item-description').value = '';
}

async function saveMenuItem() {
    const name = document.getElementById('menu-item-name').value.trim();
    const category = document.getElementById('menu-item-category').value;
    const price = parseFloat(document.getElementById('menu-item-price').value);
    const cost = parseFloat(document.getElementById('menu-item-cost').value);
    const cookTime = parseInt(document.getElementById('menu-item-cooktime').value);
    const description = document.getElementById('menu-item-description').value.trim();
    
    if (!name || !price || !cost || !cookTime) {
        showToast('Please fill all required fields', 'error');
        return;
    }
    
    if (price <= 0 || cost <= 0 || cookTime <= 0) {
        showToast('Price, cost, and cook time must be positive numbers', 'error');
        return;
    }
    
    try {
        const menuItem = {
            id: generateId(),
            name: name,
            category: category,
            price: price,
            cost: cost,
            cookTime: cookTime,
            description: description,
            status: 'active',
            createdAt: new Date().toISOString(),
            createdBy: currentUser.uid
        };
        
        // Save to Firestore
        await firebaseFirestore.collection('menuItems').doc(menuItem.id).set(menuItem);
        
        // Close modal
        document.getElementById('menu-modal').style.display = 'none';
        
        showToast(`Menu item "${name}" added successfully`, 'success');
        
    } catch (error) {
        console.error('Error saving menu item:', error);
        showToast('Error saving menu item', 'error');
    }
}

// ==================== DATA LOADING ====================
async function loadInitialData() {
    showLoading('Loading data...');
    
    try {
        // Load all data in parallel
        await Promise.all([
            loadOrders(),
            loadStaff(),
            loadMenuItems(),
            loadAttendance(),
            loadPayroll()
        ]);
        
        // Update current tab
        loadTabContent(currentTab);
        
        showToast('Data loaded successfully', 'success');
        
    } catch (error) {
        console.error('Error loading initial data:', error);
        showToast('Error loading data', 'error');
    } finally {
        hideLoading();
    }
}

async function loadOrders() {
    const snapshot = await firebaseFirestore.collection('orders')
        .orderBy('createdAt', 'desc')
        .limit(100)
        .get();
    
    orders = snapshot.docs.map(doc => doc.data());
    console.log(`Loaded ${orders.length} orders`);
}

async function loadStaff() {
    const snapshot = await firebaseFirestore.collection('staff')
        .where('active', '==', true)
        .get();
    
    staff = snapshot.docs.map(doc => doc.data());
    console.log(`Loaded ${staff.length} staff members`);
}

async function loadMenuItems() {
    const snapshot = await firebaseFirestore.collection('menuItems')
        .where('status', '==', 'active')
        .get();
    
    menuItems = snapshot.docs.map(doc => doc.data());
    console.log(`Loaded ${menuItems.length} menu items`);
}

async function loadAttendance() {
    const today = new Date().toISOString().split('T')[0];
    const snapshot = await firebaseFirestore.collection('attendance')
        .where('date', '==', today)
        .get();
    
    attendance = snapshot.docs.map(doc => doc.data());
    console.log(`Loaded ${attendance.length} attendance records`);
}

async function loadPayroll() {
    const snapshot = await firebaseFirestore.collection('payroll')
        .orderBy('period', 'desc')
        .limit(10)
        .get();
    
    payroll = snapshot.docs.map(doc => doc.data());
    console.log(`Loaded ${payroll.length} payroll records`);
}

function setupRealtimeListeners() {
    // Orders listener
    realtimeListeners.orders = firebaseFirestore.collection('orders')
        .orderBy('createdAt', 'desc')
        .limit(100)
        .onSnapshot((snapshot) => {
            orders = snapshot.docs.map(doc => doc.data());
            console.log('Orders updated in real-time');
            
            // Update UI if on relevant tabs
            if (currentTab === 'dashboard') updateDashboard();
            if (currentTab === 'orders') updateOrdersView();
            if (currentTab === 'kitchen') updateKitchenView();
        });
    
    // Staff listener
    realtimeListeners.staff = firebaseFirestore.collection('staff')
        .where('active', '==', true)
        .onSnapshot((snapshot) => {
            staff = snapshot.docs.map(doc => doc.data());
            console.log('Staff updated in real-time');
            
            if (currentTab === 'staff') updateStaffTable();
        });
    
    // Menu items listener
    realtimeListeners.menuItems = firebaseFirestore.collection('menuItems')
        .where('status', '==', 'active')
        .onSnapshot((snapshot) => {
            menuItems = snapshot.docs.map(doc => doc.data());
            console.log('Menu items updated in real-time');
            
            if (currentTab === 'menu') updateMenuTable();
        });
    
    // Attendance listener
    realtimeListeners.attendance = firebaseFirestore.collection('attendance')
        .where('date', '==', new Date().toISOString().split('T')[0])
        .onSnapshot((snapshot) => {
            attendance = snapshot.docs.map(doc => doc.data());
            console.log('Attendance updated in real-time');
            
            if (currentTab === 'attendance') updateAttendanceView();
        });
}

// ==================== UTILITY FUNCTIONS ====================
function generateId() {
    return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
}

function generateOrderNumber() {
    const prefix = 'SMFB';
    const now = new Date();
    const dateStr = now.getFullYear().toString().substr(-2) + 
                  (now.getMonth() + 1).toString().padStart(2, '0') + 
                  now.getDate().toString().padStart(2, '0');
    const count = orders.filter(o => o.orderNumber && o.orderNumber.includes(dateStr)).length + 1;
    return `${prefix}-${dateStr}-${count.toString().padStart(3, '0')}`;
}

function getDateString(daysOffset) {
    const date = new Date();
    date.setDate(date.getDate() + daysOffset);
    return date.toISOString().split('T')[0];
}

function updateCurrentDate() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-GB', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    document.getElementById('current-date').textContent = dateStr;
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    
    if (!toast || !toastMessage) {
        console.log('Toast:', message);
        return;
    }
    
    toastMessage.textContent = message;
    toast.className = `toast ${type}`;
    toast.style.display = 'flex';
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.style.display = 'none';
        }, 300);
    }, 3000);
}

function showLoginError(message) {
    const errorDiv = document.getElementById('login-error');
    const errorMessage = document.getElementById('error-message');
    
    if (errorDiv && errorMessage) {
        errorMessage.textContent = message;
        errorDiv.style.display = 'block';
    }
}

function hideLoginError() {
    const errorDiv = document.getElementById('login-error');
    if (errorDiv) {
        errorDiv.style.display = 'none';
    }
}

function showLoading(message) {
    // Create loading overlay
    let loading = document.getElementById('loading-overlay');
    
    if (!loading) {
        loading = document.createElement('div');
        loading.id = 'loading-overlay';
        loading.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;
        
        loading.innerHTML = `
            <div class="spinner"></div>
            <div style="color: var(--white); margin-top: 20px;">${message}</div>
        `;
        
        document.body.appendChild(loading);
    }
}

function hideLoading() {
    const loading = document.getElementById('loading-overlay');
    if (loading) {
        loading.remove();
    }
}

function playNotificationSound() {
    if (!soundEnabled) return;
    
    try {
        const audio = document.getElementById('notification-sound');
        audio.currentTime = 0;
        audio.play().catch(e => console.log('Audio play failed:', e));
    } catch (e) {
        console.log('Sound error:', e);
    }
}

function startAutoRefresh() {
    clearInterval(autoRefreshIntervals.dashboard);
    
    autoRefreshIntervals.dashboard = setInterval(() => {
        if (currentTab === 'dashboard') {
            updateDashboard();
        }
    }, 30000); // 30 seconds
}

function startKitchenAutoRefresh() {
    clearInterval(autoRefreshIntervals.kitchen);
    
    autoRefreshIntervals.kitchen = setInterval(() => {
        if (currentTab === 'kitchen') {
            updateKitchenView();
        }
    }, 10000); // 10 seconds
}

function clearAllIntervals() {
    Object.values(autoRefreshIntervals).forEach(interval => {
        if (interval) clearInterval(interval);
    });
    autoRefreshIntervals = {};
}

// ==================== EVENT LISTENERS ====================
function initEventListeners() {
    // Login
    document.getElementById('login-btn').addEventListener('click', firebaseLogin);
    document.getElementById('register-btn').addEventListener('click', registerAccount);
    
    // Enter key for login
    document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') firebaseLogin();
    });
    
    // Logout
    document.getElementById('logout-btn').addEventListener('click', firebaseLogout);
    
    // Modal close buttons
    document.getElementById('close-staff-modal')?.addEventListener('click', function() {
        document.getElementById('staff-modal').style.display = 'none';
    });
    
    document.getElementById('close-menu-modal')?.addEventListener('click', function() {
        document.getElementById('menu-modal').style.display = 'none';
    });
    
    document.getElementById('close-order-modal')?.addEventListener('click', function() {
        document.getElementById('order-modal').style.display = 'none';
    });
    
    document.getElementById('close-attendance-modal')?.addEventListener('click', function() {
        document.getElementById('attendance-modal').style.display = 'none';
    });
    
    document.getElementById('close-payroll-modal')?.addEventListener('click', function() {
        document.getElementById('payroll-modal').style.display = 'none';
    });
    
    // Modal cancel buttons
    document.getElementById('cancel-staff')?.addEventListener('click', function() {
        document.getElementById('staff-modal').style.display = 'none';
    });
    
    document.getElementById('cancel-menu-item')?.addEventListener('click', function() {
        document.getElementById('menu-modal').style.display = 'none';
    });
    
    document.getElementById('clear-order-form')?.addEventListener('click', function() {
        selectedOrderItems = [];
        updateSelectedItemsDisplay();
        updateOrderTotal();
    });
    
    document.getElementById('cancel-attendance')?.addEventListener('click', function() {
        document.getElementById('attendance-modal').style.display = 'none';
    });
    
    document.getElementById('cancel-payroll')?.addEventListener('click', function() {
        document.getElementById('payroll-modal').style.display = 'none';
    });
    
    // Modal save buttons
    document.getElementById('save-staff-btn')?.addEventListener('click', saveStaff);
    document.getElementById('save-menu-item-btn')?.addEventListener('click', saveMenuItem);
    document.getElementById('submit-order-btn')?.addEventListener('click', submitOrder);
    document.getElementById('save-attendance-btn')?.addEventListener('click', saveAttendance);
    
    // Sound toggle
    document.getElementById('sound-toggle')?.addEventListener('click', function() {
        soundEnabled = !soundEnabled;
        this.classList.toggle('active', soundEnabled);
        this.title = soundEnabled ? 'Sound notifications ON' : 'Sound notifications OFF';
        showToast(`Sound notifications ${soundEnabled ? 'enabled' : 'disabled'}`, 'info');
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });
}

// ==================== GLOBAL FUNCTIONS ====================
window.adjustOrderQuantity = function(index, change) {
    if (!selectedOrderItems[index]) return;
    
    selectedOrderItems[index].quantity = (selectedOrderItems[index].quantity || 0) + change;
    
    if (selectedOrderItems[index].quantity <= 0) {
        selectedOrderItems.splice(index, 1);
    }
    
    updateSelectedItemsDisplay();
    updateOrderTotal();
};

window.removeOrderItem = function(index) {
    selectedOrderItems.splice(index, 1);
    updateSelectedItemsDisplay();
    updateOrderTotal();
};

window.clearFilters = function() {
    document.getElementById('filter-date-from').value = new Date().toISOString().split('T')[0];
    document.getElementById('filter-date-to').value = new Date().toISOString().split('T')[0];
    document.getElementById('filter-status').value = 'all';
    document.getElementById('filter-type').value = 'all';
    updateOrdersView();
};

window.startShift = function() {
    showToast('Shift started', 'success');
};

window.endShift = function() {
    showToast('Shift ended', 'success');
};

window.updateAttendance = function(attendanceId, status) {
    showToast(`Attendance marked as ${status}`, 'info');
    // In a real implementation, this would update Firestore
};

window.exportReport = function() {
    showToast('Export feature coming soon', 'info');
};

window.printReport = function() {
    window.print();
};

// Initialize the system
console.log('Complete Restaurant Management System v4.0 Initialized');
    </script>
</body>
</html>
